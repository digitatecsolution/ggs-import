<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>GGS Global Consult ‚Äî Admin Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:wght@400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --ink:#08090C;--ink2:#0C0D11;--surface:#111318;
  --card:#161820;--card2:#1C1E28;
  --gold-deep:#9A6B0A;--gold:#C8891A;--gold-mid:#E09E28;--gold-bright:#F5B945;
  --teal:#0B6E5C;--teal-mid:#0D8A72;--teal-bright:#12B896;
  --red:#DC2626;--white:#F0EDE7;--muted:#5C5968;--muted2:#8C8898;
  --sidebar-w:260px;--topbar-h:64px;
  --radius:12px;--radius-sm:8px;
  --transition:0.22s cubic-bezier(.4,0,.2,1);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--ink);color:var(--white);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;line-height:1.5;}

::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--muted);border-radius:3px;}

/* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
#auth-screen{position:fixed;inset:0;z-index:9999;background:radial-gradient(ellipse at 30% 40%,#0D8A7220 0%,transparent 60%),var(--ink);display:flex;align-items:center;justify-content:center;}
.auth-card{background:var(--card);border:1px solid #ffffff12;border-radius:20px;padding:48px 40px;width:100%;max-width:420px;box-shadow:0 24px 80px #00000080;}
.auth-logo{text-align:center;margin-bottom:32px;}
.auth-logo h1{font-family:'Playfair Display',serif;font-size:28px;color:var(--gold-bright);letter-spacing:1px;}
.auth-logo p{color:var(--muted2);font-size:13px;margin-top:4px;}
.auth-card label{display:block;font-size:12px;font-weight:600;color:var(--muted2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;}
.auth-card input{width:100%;background:var(--ink2);border:1px solid #ffffff14;border-radius:var(--radius-sm);padding:12px 14px;color:var(--white);font-family:inherit;font-size:14px;outline:none;transition:border-color var(--transition);}
.auth-card input:focus{border-color:var(--teal-bright);}
.auth-group{margin-bottom:20px;}
.btn-auth{width:100%;padding:13px;border:none;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--teal),var(--teal-mid));color:#fff;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;transition:opacity var(--transition);}
.btn-auth:hover{opacity:.85;}
#auth-error{color:var(--red);font-size:13px;text-align:center;margin-top:12px;min-height:20px;}

/* ‚îÄ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ‚îÄ */
#app{display:none;height:100vh;overflow:hidden;}
#app.visible{display:flex;}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
#sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:var(--ink2);border-right:1px solid #ffffff0a;display:flex;flex-direction:column;height:100vh;overflow:hidden;transition:transform var(--transition),width var(--transition);z-index:200;position:relative;}
.sidebar-header{padding:20px 20px 16px;border-bottom:1px solid #ffffff08;flex-shrink:0;}
.sidebar-logo{font-family:'Playfair Display',serif;font-size:18px;color:var(--gold-bright);letter-spacing:.5px;}
.sidebar-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.sidebar-nav{flex:1;overflow-y:auto;padding:12px 8px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);cursor:pointer;transition:background var(--transition),color var(--transition);color:var(--muted2);font-weight:500;position:relative;user-select:none;}
.nav-item:hover{background:#ffffff08;color:var(--white);}
.nav-item.active{background:linear-gradient(135deg,#0D8A7230,#0B6E5C20);color:var(--teal-bright);border:1px solid #0D8A7240;}
.nav-item .nav-icon{font-size:18px;width:24px;text-align:center;flex-shrink:0;}
.nav-item .nav-label{flex:1;}
.nav-badge{background:var(--red);color:#fff;font-size:11px;font-weight:700;padding:2px 7px;border-radius:20px;min-width:20px;text-align:center;}
.sidebar-footer{padding:16px;border-top:1px solid #ffffff08;flex-shrink:0;}
.admin-email{font-size:11px;color:var(--muted);margin-bottom:10px;word-break:break-all;}
.btn-logout{width:100%;padding:9px;border:1px solid #ffffff14;border-radius:var(--radius-sm);background:transparent;color:var(--muted2);font-family:inherit;font-size:13px;cursor:pointer;transition:all var(--transition);}
.btn-logout:hover{background:var(--red);border-color:var(--red);color:#fff;}

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
#topbar{height:var(--topbar-h);background:var(--ink2);border-bottom:1px solid #ffffff08;display:flex;align-items:center;padding:0 24px;gap:16px;flex-shrink:0;}
#hamburger{display:none;background:none;border:none;color:var(--white);font-size:22px;cursor:pointer;padding:4px;}
.topbar-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--white);flex:1;}
.topbar-actions{display:flex;align-items:center;gap:10px;}
.btn-topbar{padding:8px 16px;border-radius:var(--radius-sm);border:1px solid #ffffff14;background:transparent;color:var(--muted2);font-family:inherit;font-size:13px;cursor:pointer;transition:all var(--transition);}
.btn-topbar:hover{background:#ffffff0a;color:var(--white);}
#content{flex:1;overflow-y:auto;padding:24px;}

/* ‚îÄ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ‚îÄ */
.panel{display:none;}
.panel.active{display:block;}

/* ‚îÄ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;}
.stat-card{background:var(--card);border:1px solid #ffffff0a;border-radius:var(--radius);padding:20px;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;right:0;width:80px;height:80px;border-radius:50%;filter:blur(30px);opacity:.3;}
.stat-card.revenue::before{background:var(--gold);}
.stat-card.orders::before{background:var(--teal);}
.stat-card.products::before{background:#6366f1;}
.stat-card.pending::before{background:var(--red);}
.stat-label{font-size:12px;color:var(--muted2);font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;}
.stat-val{font-family:'Bebas Neue',sans-serif;font-size:36px;line-height:1;letter-spacing:1px;}
.stat-card.revenue .stat-val{color:var(--gold-bright);}
.stat-card.orders .stat-val{color:var(--teal-bright);}
.stat-card.products .stat-val{color:#818cf8;}
.stat-card.pending .stat-val{color:#f87171;}
.stat-sub{font-size:11px;color:var(--muted);margin-top:6px;}

/* ‚îÄ‚îÄ‚îÄ QUICK CARDS ‚îÄ‚îÄ‚îÄ */
.quick-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;}
.quick-card{background:var(--card2);border:1px solid #ffffff0a;border-radius:var(--radius);padding:20px;cursor:pointer;transition:all var(--transition);text-align:center;}
.quick-card:hover{border-color:var(--teal-mid);transform:translateY(-2px);box-shadow:0 8px 30px #0D8A7220;}
.quick-icon{font-size:28px;margin-bottom:10px;}
.quick-title{font-weight:600;font-size:13px;color:var(--white);}
.quick-sub{font-size:11px;color:var(--muted);margin-top:3px;}

/* ‚îÄ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ‚îÄ */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.section-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--white);}

/* ‚îÄ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ */
.table-wrap{background:var(--card);border:1px solid #ffffff0a;border-radius:var(--radius);overflow:hidden;}
.tbl-scroll{overflow-x:auto;}
table{width:100%;border-collapse:collapse;white-space:nowrap;}
thead th{background:var(--card2);padding:12px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid #ffffff08;}
tbody tr{border-bottom:1px solid #ffffff06;transition:background var(--transition);}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:#ffffff04;}
tbody td{padding:12px 16px;font-size:13px;color:var(--white);}

/* ‚îÄ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}
.badge-teal{background:#0D8A7230;color:var(--teal-bright);border:1px solid #0D8A7250;}
.badge-gold{background:#C8891A25;color:var(--gold-bright);border:1px solid #C8891A40;}
.badge-red{background:#DC262620;color:#f87171;border:1px solid #DC262640;}
.badge-muted{background:#ffffff0a;color:var(--muted2);border:1px solid #ffffff14;}
.badge-purple{background:#6366f120;color:#a5b4fc;border:1px solid #6366f140;}
.badge-green{background:#16a34a20;color:#4ade80;border:1px solid #16a34a40;}
.badge-hot{background:#ef444420;color:#fca5a5;border:1px solid #ef444440;}
.badge-new{background:#3b82f620;color:#93c5fd;border:1px solid #3b82f640;}
.badge-pick{background:#f59e0b20;color:#fcd34d;border:1px solid #f59e0b40;}

/* ‚îÄ‚îÄ‚îÄ FILTER TABS ‚îÄ‚îÄ‚îÄ */
.filter-tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.filter-tab{padding:7px 16px;border-radius:20px;border:1px solid #ffffff14;background:transparent;color:var(--muted2);font-family:inherit;font-size:13px;cursor:pointer;transition:all var(--transition);}
.filter-tab:hover{border-color:var(--teal-mid);color:var(--teal-bright);}
.filter-tab.active{background:var(--teal);border-color:var(--teal-mid);color:#fff;}

/* ‚îÄ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ‚îÄ */
.search-bar{display:flex;gap:10px;margin-bottom:16px;}
.search-input{flex:1;background:var(--card);border:1px solid #ffffff14;border-radius:var(--radius-sm);padding:10px 14px;color:var(--white);font-family:inherit;font-size:13px;outline:none;transition:border-color var(--transition);}
.search-input:focus{border-color:var(--teal-bright);}
.search-input::placeholder{color:var(--muted);}

/* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
.btn{padding:9px 18px;border-radius:var(--radius-sm);border:none;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all var(--transition);display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:linear-gradient(135deg,var(--teal),var(--teal-mid));color:#fff;}
.btn-primary:hover{opacity:.85;transform:translateY(-1px);}
.btn-gold{background:linear-gradient(135deg,var(--gold-deep),var(--gold));color:#fff;}
.btn-gold:hover{opacity:.85;}
.btn-danger{background:var(--red);color:#fff;}
.btn-danger:hover{opacity:.85;}
.btn-outline{background:transparent;border:1px solid #ffffff20;color:var(--muted2);}
.btn-outline:hover{background:#ffffff0a;color:var(--white);}
.btn-sm{padding:6px 12px;font-size:12px;}
.btn-icon{padding:6px 8px;font-size:16px;}
.btn-full{width:100%;justify-content:center;}

/* ‚îÄ‚îÄ‚îÄ PRODUCT THUMB ‚îÄ‚îÄ‚îÄ */
.prod-thumb{width:40px;height:40px;border-radius:8px;object-fit:cover;background:var(--ink2);border:1px solid #ffffff10;font-size:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.prod-thumb-wrap{display:flex;align-items:center;gap:10px;}
.prod-name{font-weight:600;font-size:13px;}
.prod-spec{font-size:11px;color:var(--muted2);margin-top:1px;}

.status-select{background:var(--ink2);border:1px solid #ffffff14;border-radius:6px;color:var(--white);font-family:inherit;font-size:12px;padding:5px 8px;cursor:pointer;outline:none;}

/* ‚îÄ‚îÄ‚îÄ CATEGORY CHIPS ‚îÄ‚îÄ‚îÄ */
.cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;}
.cat-chip{background:var(--card);border:1px solid #ffffff0a;border-radius:var(--radius);padding:20px;transition:all var(--transition);}
.cat-chip:hover{border-color:var(--teal-mid);transform:translateY(-2px);}
.cat-chip-icon{font-size:32px;margin-bottom:10px;}
.cat-chip-label{font-weight:700;font-size:14px;margin-bottom:2px;}
.cat-chip-key{font-size:11px;color:var(--muted);font-family:monospace;margin-bottom:10px;}
.cat-chip-stats{display:flex;gap:8px;margin-bottom:12px;font-size:11px;}
.cat-stat{background:var(--ink2);padding:3px 8px;border-radius:4px;color:var(--muted2);}
.cat-stat span{color:var(--white);font-weight:600;}

/* ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.settings-section{background:var(--card);border:1px solid #ffffff0a;border-radius:var(--radius);padding:24px;}
.settings-section h3{font-family:'Playfair Display',serif;font-size:16px;margin-bottom:16px;color:var(--gold-bright);}
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--muted2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;}
.form-input{width:100%;background:var(--ink2);border:1px solid #ffffff14;border-radius:var(--radius-sm);padding:10px 14px;color:var(--white);font-family:inherit;font-size:14px;outline:none;transition:border-color var(--transition);}
.form-input:focus{border-color:var(--teal-bright);}
textarea.form-input{resize:vertical;min-height:80px;}
.toggle-wrap{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #ffffff08;}
.toggle-wrap:last-child{border-bottom:none;}
.toggle-label{font-size:14px;font-weight:500;}
.toggle-sub{font-size:11px;color:var(--muted);margin-top:1px;}
.toggle{position:relative;width:44px;height:24px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;position:absolute;}
.toggle-track{position:absolute;inset:0;background:#ffffff14;border-radius:12px;cursor:pointer;transition:background var(--transition);}
.toggle input:checked ~ .toggle-track{background:var(--teal-mid);}
.toggle-track::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform var(--transition);box-shadow:0 1px 4px #0004;}
.toggle input:checked ~ .toggle-track::after{transform:translateX(20px);}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:500;align-items:center;justify-content:center;padding:20px;}
.modal-bg.open{display:flex;}
.modal-box{background:var(--card);border:1px solid #ffffff12;border-radius:20px;width:100%;max-width:640px;max-height:92vh;overflow-y:auto;position:relative;box-shadow:0 30px 80px #000000a0;}
.modal-box::-webkit-scrollbar{width:4px;}
.modal-box::-webkit-scrollbar-thumb{background:rgba(200,137,26,.2);border-radius:4px;}
.modal-header{padding:24px 28px 0;border-bottom:1px solid #ffffff08;padding-bottom:18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--card);z-index:1;}
.modal-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--gold-bright);}
.modal-close{background:rgba(255,255,255,.06);border:1px solid #ffffff12;border-radius:50%;width:34px;height:34px;display:grid;place-items:center;cursor:pointer;color:var(--muted2);font-size:16px;transition:all var(--transition);flex-shrink:0;}
.modal-close:hover{color:var(--white);background:rgba(255,255,255,.12);}
.modal-body{padding:24px 28px 28px;}
.modal-footer{padding:0 28px 24px;display:flex;gap:10px;justify-content:flex-end;}

/* ‚îÄ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-select{width:100%;background:var(--ink2);border:1px solid #ffffff14;border-radius:var(--radius-sm);padding:10px 14px;color:var(--white);font-family:inherit;font-size:14px;outline:none;transition:border-color var(--transition);-webkit-appearance:none;}
.form-select:focus{border-color:var(--teal-bright);}
.form-select option{background:var(--card);}

/* ‚îÄ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ‚îÄ */
.img-upload-wrap{border:2px dashed #ffffff18;border-radius:var(--radius);padding:20px;text-align:center;cursor:pointer;transition:all var(--transition);background:var(--ink2);}
.img-upload-wrap:hover{border-color:var(--teal-mid);background:#0D8A7210;}
.img-upload-wrap.dragover{border-color:var(--teal-bright);background:#12B89610;}
.img-preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin-top:12px;}
.img-preview-item{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;border:1px solid #ffffff14;}
.img-preview-item img{width:100%;height:100%;object-fit:cover;}
.img-preview-item .img-del{position:absolute;top:3px;right:3px;background:rgba(220,38,38,.85);border:none;border-radius:4px;color:#fff;font-size:11px;padding:2px 5px;cursor:pointer;font-family:inherit;}
.img-preview-item.primary-img::after{content:'PRIMARY';position:absolute;bottom:0;left:0;right:0;background:rgba(200,137,26,.85);color:#fff;font-size:9px;font-weight:700;text-align:center;padding:2px;letter-spacing:.5px;}

/* ‚îÄ‚îÄ‚îÄ VARIANT MANAGER ‚îÄ‚îÄ‚îÄ */
.variant-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
.variant-row input{flex:1;background:var(--ink2);border:1px solid #ffffff14;border-radius:var(--radius-sm);padding:9px 12px;color:var(--white);font-family:inherit;font-size:13px;outline:none;}
.variant-row input:focus{border-color:var(--teal-bright);}
.variant-row .v-price{width:130px;}
.variant-row .v-cny{width:110px;}
.variant-row .btn-icon{flex-shrink:0;}
.add-variant-btn{background:transparent;border:1px dashed #ffffff22;border-radius:var(--radius-sm);padding:8px;color:var(--muted2);font-size:12px;cursor:pointer;width:100%;font-family:inherit;transition:all var(--transition);}
.add-variant-btn:hover{border-color:var(--teal-mid);color:var(--teal-bright);}
.color-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
.color-row input{flex:1;background:var(--ink2);border:1px solid #ffffff14;border-radius:var(--radius-sm);padding:9px 12px;color:var(--white);font-family:inherit;font-size:13px;outline:none;}
.color-row input:focus{border-color:var(--gold);}

/* ‚îÄ‚îÄ‚îÄ CHAR COUNTER ‚îÄ‚îÄ‚îÄ */
.char-counter{font-size:11px;color:var(--muted);text-align:right;margin-top:4px;}
.char-counter.warn{color:#f59e0b;}
.char-counter.over{color:var(--red);}

/* ‚îÄ‚îÄ‚îÄ PRICING CALCULATOR ‚îÄ‚îÄ‚îÄ */
.calc-box{background:var(--card);border:1px solid #ffffff0a;border-radius:var(--radius);padding:24px;}
.calc-result{background:linear-gradient(135deg,#0D8A7220,#0B6E5C10);border:1px solid #0D8A7240;border-radius:var(--radius);padding:20px;margin-top:16px;text-align:center;}
.calc-price{font-family:'Bebas Neue',sans-serif;font-size:42px;color:var(--gold-bright);letter-spacing:2px;}
.calc-breakdown{margin-top:12px;display:flex;flex-direction:column;gap:6px;}
.calc-line{display:flex;justify-content:space-between;font-size:12px;color:var(--muted2);padding:4px 0;border-bottom:1px solid #ffffff06;}
.calc-line:last-child{border-bottom:none;}
.calc-line span:last-child{color:var(--white);font-weight:600;}

/* ‚îÄ‚îÄ‚îÄ REPRICE PANEL ‚îÄ‚îÄ‚îÄ */
.reprice-section{background:var(--card);border:1px solid #ffffff0a;border-radius:var(--radius);padding:24px;margin-bottom:20px;}
.reprice-section h3{font-family:'Playfair Display',serif;font-size:16px;color:var(--gold-bright);margin-bottom:16px;}
.reprice-rate-display{background:var(--ink2);border:1px solid #0D8A7240;border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.reprice-rate-val{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--teal-bright);}
.reprice-rate-label{font-size:12px;color:var(--muted2);}
.reprice-preview-table tbody tr.price-up td.change-col{color:#4ade80;}
.reprice-preview-table tbody tr.price-down td.change-col{color:#f87171;}
.reprice-preview-table tbody tr.no-cost td{opacity:.5;}
.reprice-action-bar{background:linear-gradient(135deg,#0D8A7220,#0B6E5C10);border:1px solid #0D8A7240;border-radius:var(--radius);padding:20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
.reprice-summary{flex:1;font-size:13px;color:var(--muted2);}
.reprice-summary strong{color:var(--white);}
.reprice-progress{background:var(--ink2);border:1px solid #ffffff0a;border-radius:var(--radius);padding:24px;text-align:center;margin-top:16px;}
.progress-bar-wrap{background:#ffffff10;border-radius:4px;height:8px;margin:12px 0;overflow:hidden;}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-bright));border-radius:4px;transition:width .3s ease;}
.missing-cost-section{background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.2);border-radius:var(--radius);padding:20px;margin-top:20px;}
.missing-cost-section h4{font-size:14px;color:#f87171;margin-bottom:12px;}
.suggested-price-hint{background:linear-gradient(135deg,#0D8A7215,#0B6E5C0a);border:1px solid #0D8A7230;border-radius:6px;padding:8px 12px;font-size:12px;color:var(--teal-bright);margin-top:6px;}

/* ‚îÄ‚îÄ‚îÄ REVENUE CHART (simple bars) ‚îÄ‚îÄ‚îÄ */
.mini-chart{display:flex;align-items:flex-end;gap:4px;height:80px;margin-top:8px;}
.mini-bar{flex:1;background:linear-gradient(to top,var(--teal),var(--teal-mid));border-radius:3px 3px 0 0;min-height:4px;transition:height .4s ease;cursor:pointer;position:relative;}
.mini-bar:hover::after{content:attr(data-label);position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid #ffffff14;border-radius:4px;padding:3px 7px;font-size:10px;white-space:nowrap;color:var(--white);}

/* ‚îÄ‚îÄ‚îÄ NOTIFICATION TOAST ‚îÄ‚îÄ‚îÄ */
#admin-toast{position:fixed;bottom:24px;right:24px;z-index:9000;background:var(--card);border:1px solid #0D8A7250;border-radius:var(--radius-sm);padding:14px 20px;color:var(--teal-bright);font-size:13px;font-weight:600;box-shadow:0 8px 32px #000000a0;transform:translateY(100px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;max-width:320px;}
#admin-toast.show{transform:translateY(0);opacity:1;}
#admin-toast.error{border-color:#DC262650;color:#f87171;}

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted2);}
.empty-icon{font-size:48px;margin-bottom:16px;display:block;opacity:.4;}
.empty-text{font-size:14px;}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
#sidebar-overlay{display:none;position:fixed;inset:0;background:#00000060;z-index:199;}
@media(max-width:900px){
  #sidebar{position:fixed;top:0;left:0;bottom:0;transform:translateX(-100%);z-index:200;}
  #sidebar.open{transform:translateX(0);}
  #sidebar-overlay.show{display:block;}
  #hamburger{display:block;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .quick-grid{grid-template-columns:repeat(2,1fr);}
  .settings-grid{grid-template-columns:1fr;}
  .form-row{grid-template-columns:1fr;}
}
@media(max-width:560px){
  .stats-grid{grid-template-columns:1fr 1fr;}
  #content{padding:16px;}
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">
      <h1>GGS Admin</h1>
      <p>Dashboard ‚Äî Authorized Access Only</p>
    </div>
    <div class="auth-group">
      <label for="au-email">Email Address</label>
      <input type="email" id="au-email" placeholder="admin@ggsglobal.store" autocomplete="username">
    </div>
    <div class="auth-group">
      <label for="au-pass">Password</label>
      <input type="password" id="au-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
             onkeydown="if(event.key==='Enter') doLogin()">
    </div>
    <button class="btn-auth" onclick="doLogin()">Sign In ‚Üí</button>
    <div id="auth-error"></div>
  </div>
</div>

<!-- SIDEBAR OVERLAY (mobile) -->
<div id="sidebar-overlay" onclick="closeSidebar()"></div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">GGS Global</div>
      <div class="sidebar-sub">Admin Dashboard</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" data-panel="overview" onclick="navTo('overview',this)">
        <span class="nav-icon">üìä</span><span class="nav-label">Overview</span>
      </div>
      <div class="nav-item" data-panel="orders" onclick="navTo('orders',this)">
        <span class="nav-icon">üì¶</span><span class="nav-label">Orders</span>
        <span class="nav-badge" id="pendingBadge">0</span>
      </div>
      <div class="nav-item" data-panel="products" onclick="navTo('products',this)">
        <span class="nav-icon">üõçÔ∏è</span><span class="nav-label">Products</span>
      </div>
      <div class="nav-item" data-panel="categories" onclick="navTo('categories',this)">
        <span class="nav-icon">üóÇÔ∏è</span><span class="nav-label">Categories</span>
      </div>
      <div class="nav-item" data-panel="pricing" onclick="navTo('pricing',this)">
        <span class="nav-icon">üßÆ</span><span class="nav-label">Pricing Calc</span>
      </div>
      <div class="nav-item" data-panel="reprice" onclick="navTo('reprice',this)">
        <span class="nav-icon">üí±</span><span class="nav-label">Bulk Reprice</span>
      </div>
      <div class="nav-item" data-panel="referrals" onclick="navTo('referrals',this)">
        <span class="nav-icon">üéÅ</span><span class="nav-label">Referrals</span>
      </div>
      <div class="nav-item" data-panel="settings" onclick="navTo('settings',this)">
        <span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Settings</span>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="admin-email" id="adminEmailDisplay"></div>
      <button class="btn-logout" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main">
    <!-- TOPBAR -->
    <div id="topbar">
      <button id="hamburger" onclick="toggleSidebar()">‚ò∞</button>
      <div class="topbar-title" id="topbarTitle">Overview</div>
      <div class="topbar-actions">
        <a href="/" target="_blank" class="btn-topbar">üåê View Store</a>
        <button class="btn-topbar" onclick="navTo('products')">+ Add Product</button>
      </div>
    </div>

    <!-- CONTENT PANELS -->
    <div id="content">

      <!-- ‚ïê‚ïê‚ïê OVERVIEW PANEL ‚ïê‚ïê‚ïê -->
      <div class="panel active" id="panel-overview">
        <div class="stats-grid">
          <div class="stat-card revenue">
            <div class="stat-label">Total Revenue (Paid)</div>
            <div class="stat-val" id="stat-revenue">‚Ç¶0</div>
            <div class="stat-sub" id="stat-revenue-sub">Loading‚Ä¶</div>
          </div>
          <div class="stat-card orders">
            <div class="stat-label">Total Orders</div>
            <div class="stat-val" id="stat-orders">0</div>
            <div class="stat-sub" id="stat-orders-sub">Loading‚Ä¶</div>
          </div>
          <div class="stat-card products">
            <div class="stat-label">Active Products</div>
            <div class="stat-val" id="stat-products">0</div>
            <div class="stat-sub">Listed in catalog</div>
          </div>
          <div class="stat-card pending">
            <div class="stat-label">Pending Fulfillment</div>
            <div class="stat-val" id="stat-pending">0</div>
            <div class="stat-sub">Processing / Shipped</div>
          </div>
        </div>

        <div class="quick-grid">
          <div class="quick-card" onclick="navTo('products');openProductModal()">
            <div class="quick-icon">‚ûï</div>
            <div class="quick-title">Add New Product</div>
            <div class="quick-sub">List a new item in catalog</div>
          </div>
          <div class="quick-card" onclick="navTo('orders')">
            <div class="quick-icon">üìã</div>
            <div class="quick-title">View Orders</div>
            <div class="quick-sub">Manage &amp; update status</div>
          </div>
          <div class="quick-card" onclick="navTo('reprice')">
            <div class="quick-icon">üí±</div>
            <div class="quick-title">Bulk Reprice</div>
            <div class="quick-sub">Update all prices with new rate</div>
          </div>
          <div class="quick-card" onclick="navTo('pricing')">
            <div class="quick-icon">üßÆ</div>
            <div class="quick-title">Price Calculator</div>
            <div class="quick-sub">Factory cost ‚Üí listing price</div>
          </div>
        </div>

        <div class="section-header">
          <div class="section-title">Recent Orders</div>
          <button class="btn btn-outline btn-sm" onclick="navTo('orders')">View All ‚Üí</button>
        </div>
        <div class="table-wrap">
          <div class="tbl-scroll">
            <table>
              <thead>
                <tr>
                  <th>Ref</th>
                  <th>Customer</th>
                  <th>Items</th>
                  <th>Total</th>
                  <th>Shipping</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="overview-orders-tbody">
                <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:40px">Loading orders‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê ORDERS PANEL ‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-orders">
        <div class="filter-tabs" id="order-filter-tabs">
          <button class="filter-tab active" data-status="all" onclick="filterOrders('all',this)">All Orders</button>
          <button class="filter-tab" data-status="processing" onclick="filterOrders('processing',this)">üîÑ Processing</button>
          <button class="filter-tab" data-status="shipped" onclick="filterOrders('shipped',this)">‚úàÔ∏è Shipped</button>
          <button class="filter-tab" data-status="delivered" onclick="filterOrders('delivered',this)">‚úÖ Delivered</button>
        </div>
        <div class="search-bar">
          <input class="search-input" id="order-search" placeholder="Search by name, ref, phone, state‚Ä¶" oninput="renderOrders()">
          <button class="btn btn-outline btn-sm" onclick="exportOrdersCSV()">üì• Export CSV</button>
        </div>
        <div class="table-wrap">
          <div class="tbl-scroll">
            <table>
              <thead>
                <tr>
                  <th>Ref</th>
                  <th>Customer</th>
                  <th>Phone</th>
                  <th>State</th>
                  <th>Items</th>
                  <th>Total Paid</th>
                  <th>Shipping</th>
                  <th>Order Status</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="orders-tbody">
                <tr><td colspan="10" style="text-align:center;color:var(--muted);padding:40px">Loading orders‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div id="orders-pagination" style="display:flex;gap:8px;justify-content:center;margin-top:16px;flex-wrap:wrap;"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê PRODUCTS PANEL ‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-products">
        <div class="section-header">
          <div class="section-title">Products</div>
          <button class="btn btn-primary" onclick="openProductModal()">‚ûï Add Product</button>
        </div>
        <div class="search-bar">
          <input class="search-input" id="prod-search" placeholder="Search products by name, category‚Ä¶" oninput="renderProducts()">
          <select class="form-select" id="prod-cat-filter" onchange="renderProducts()" style="width:180px;background:var(--card);border:1px solid #ffffff14;">
            <option value="">All Categories</option>
            <option value="tech">Tech</option>
            <option value="fashion">Fashion</option>
            <option value="shoes">Shoes</option>
            <option value="bags">Bags</option>
            <option value="watches">Watches</option>
            <option value="perfume">Perfumes</option>
            <option value="skincare">Skincare</option>
            <option value="gaming">Gaming</option>
            <option value="jewelry">Jewelry</option>
            <option value="kids">Kids</option>
            <option value="sports">Sports</option>
            <option value="home">Home</option>
            <option value="general">General</option>
          </select>
        </div>
        <div class="table-wrap">
          <div class="tbl-scroll">
            <table>
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Category</th>
                  <th>Base Price</th>
                  <th>Variants</th>
                  <th>Badge</th>
                  <th>Status</th>
                  <th>Sort</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="products-tbody">
                <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:40px">Loading products‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê CATEGORIES PANEL ‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-categories">
        <div class="section-header">
          <div class="section-title">Product Categories</div>
        </div>
        <div class="cat-grid" id="cat-grid-container"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê PRICING CALC PANEL ‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-pricing">
        <div class="section-header">
          <div class="section-title">GGS Pricing Calculator</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
          <div class="calc-box">
            <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--gold-bright);margin-bottom:20px;">üßÆ Calculate Listing Price</h3>

            <!-- Rate sync from settings -->
            <div id="calc-stored-rate-info" style="background:var(--ink2);border:1px solid #0D8A7230;border-radius:8px;padding:10px 14px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;">
              <div>
                <div style="font-size:11px;color:var(--muted2);text-transform:uppercase;letter-spacing:.6px;">Current Stored Rate</div>
                <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--teal-bright);margin-top:2px;" id="calc-stored-rate-display">‚Ç¶220 / ¬•1</div>
              </div>
              <button class="btn btn-outline btn-sm" onclick="syncCalcRateFromSettings()">üîÑ Sync Rate</button>
            </div>

            <div class="form-group">
              <label class="form-label">Factory Price (CNY ¬•)</label>
              <input class="form-input" type="number" id="calc-cny" placeholder="e.g. 4800" oninput="runCalc()">
            </div>
            <div class="form-group">
              <label class="form-label">Exchange Rate (‚Ç¶ per ¬•1)</label>
              <input class="form-input" type="number" id="calc-rate" placeholder="e.g. 220" value="220" oninput="runCalc()">
              <div style="font-size:11px;color:var(--muted);margin-top:4px">Update every Monday morning</div>
            </div>
            <div class="form-group">
              <label class="form-label">Sourcing Method</label>
              <select class="form-select" id="calc-source" onchange="runCalc()">
                <option value="agent">Via Agent (√ó1.06 agent fee)</option>
                <option value="direct">Direct on 1688 (no agent fee)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Product Category</label>
              <select class="form-select" id="calc-cat" onchange="runCalc()">
                <option value="1.65">üì± iPhones / Samsung (√ó1.65)</option>
                <option value="1.65">üíª MacBooks / Laptops (√ó1.65)</option>
                <option value="1.68">üì≤ iPads / Tablets (√ó1.68)</option>
                <option value="1.70">üéß AirPods / Earbuds (√ó1.70)</option>
                <option value="1.72">‚åö Smart Watches (√ó1.72)</option>
                <option value="1.70">üéÆ Gaming (√ó1.70)</option>
                <option value="1.78">üëú Designer Bags (√ó1.78)</option>
                <option value="1.80">üë† Shoes / Footwear (√ó1.80)</option>
                <option value="1.82">üå∏ Perfumes (√ó1.82)</option>
                <option value="1.82">üíç Jewelry (√ó1.82)</option>
                <option value="1.82">‚ú® Skincare / Beauty (√ó1.82)</option>
                <option value="1.82">üíº Accessories (√ó1.82)</option>
                <option value="1.75">üß∏ Kids Items (√ó1.75)</option>
              </select>
            </div>
            <div class="calc-result" id="calc-result" style="display:none">
              <div style="font-size:12px;color:var(--muted2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.8px;">Suggested Listing Price</div>
              <div class="calc-price" id="calc-final">‚Ç¶0</div>
              <div class="calc-breakdown" id="calc-breakdown"></div>
              <button class="btn btn-gold btn-full btn-sm" style="margin-top:16px" onclick="useCalcPrice()">Use This Price ‚Üí</button>
            </div>
          </div>
          <div class="calc-box">
            <h3 style="font-family:'Playfair Display',serif;font-size:16px;color:var(--gold-bright);margin-bottom:16px;">üìê Formula Reference</h3>
            <div style="display:flex;flex-direction:column;gap:10px;font-size:13px;">
              <div style="background:var(--ink2);border-radius:8px;padding:14px;">
                <div style="font-weight:700;color:var(--white);margin-bottom:8px;">Master Formula</div>
                <code style="color:var(--gold-bright);font-size:12px;line-height:1.8;display:block;">
                  CNY √ó Exchange Rate<br>
                  √ó 1.15 (buffer 15%)<br>
                  √ó 1.06 (agent fee ‚Äî skip if 1688)<br>
                  √ó 1.08 (ops &amp; handling 8%)<br>
                  √ó 1.014 (Flutterwave 1.4%)<br>
                  √ó Category Multiplier<br>
                  ‚Üí CEIL to nearest ‚Ç¶5,000
                </code>
              </div>
              <div style="background:var(--ink2);border-radius:8px;padding:14px;">
                <div style="font-weight:700;color:var(--white);margin-bottom:8px;">Quick Reference ‚Äî Multipliers</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;color:var(--muted2);">
                  <span>iPhones/MacBooks</span><span style="color:var(--gold)">√ó1.65 / √ó1.56</span>
                  <span>Bags</span><span style="color:var(--gold)">√ó1.78 / √ó1.68</span>
                  <span>Shoes</span><span style="color:var(--gold)">√ó1.80 / √ó1.70</span>
                  <span>Perfumes/Jewelry</span><span style="color:var(--gold)">√ó1.82 / √ó1.72</span>
                  <span>Watches</span><span style="color:var(--gold)">√ó1.72 / √ó1.63</span>
                  <span>Gaming</span><span style="color:var(--gold)">√ó1.70 / √ó1.61</span>
                </div>
              </div>
              <div style="background:rgba(220,38,38,.08);border:1px solid rgba(220,38,38,.2);border-radius:8px;padding:14px;">
                <div style="font-size:12px;color:#f87171;line-height:1.7;">‚ö†Ô∏è Always update the exchange rate every <strong>Monday morning</strong> before pricing new products. Rate deviation by ‚Ç¶5+ affects margins significantly.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê BULK REPRICE PANEL ‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-reprice">
        <div class="section-header">
          <div class="section-title">üí± Bulk Reprice Engine</div>
        </div>

        <!-- Section A: Rate Input -->
        <div class="reprice-section">
          <h3>Section A ‚Äî Set New Exchange Rate</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start;">
            <div>
              <div class="reprice-rate-display">
                <div>
                  <div class="reprice-rate-label">Current Stored Rate</div>
                  <div class="reprice-rate-val" id="reprice-current-rate">‚Ç¶‚Äî</div>
                  <div style="font-size:11px;color:var(--muted);margin-top:2px;" id="reprice-rate-updated">Not yet loaded</div>
                </div>
              </div>
              <div class="form-group" style="margin-bottom:12px">
                <label class="form-label">New Exchange Rate (‚Ç¶ per ¬•1 CNY)</label>
                <input class="form-input" type="number" id="reprice-new-rate" placeholder="e.g. 235" oninput="clearRepricePreview()">
              </div>
              <div style="background:rgba(220,38,38,.08);border:1px solid rgba(220,38,38,.2);border-radius:8px;padding:10px 14px;font-size:12px;color:#f87171;margin-bottom:16px;">
                ‚ö†Ô∏è Update every <strong>Monday morning</strong> before repricing. Rate deviation affects all product margins.
              </div>
              <button class="btn btn-gold" onclick="previewReprice()" style="width:100%;justify-content:center;">üîç Preview Impact</button>
            </div>
            <div style="background:var(--ink2);border-radius:var(--radius);padding:16px;font-size:13px;">
              <div style="font-weight:700;color:var(--white);margin-bottom:10px;">How It Works</div>
              <div style="display:flex;flex-direction:column;gap:8px;color:var(--muted2);">
                <div>1Ô∏è‚É£ Enter the new ‚Ç¶/¬• rate</div>
                <div>2Ô∏è‚É£ Click <strong style="color:var(--white)">Preview Impact</strong> to see all price changes</div>
                <div>3Ô∏è‚É£ Uncheck any products to exclude</div>
                <div>4Ô∏è‚É£ Click <strong style="color:var(--white)">Apply New Rate</strong> to batch-update Firestore</div>
                <div style="margin-top:6px;padding:8px;background:#ffffff06;border-radius:6px;font-size:11px;">Only products with a Factory Cost (CNY) stored will be updated. Products without it are flagged below.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section B: Preview Table (hidden until preview) -->
        <div id="reprice-preview-wrap" style="display:none;">
          <div class="reprice-section">
            <h3>Section B ‚Äî Price Preview</h3>
            <div id="reprice-preview-summary-top" style="font-size:13px;color:var(--muted2);margin-bottom:16px;"></div>
            <div class="table-wrap">
              <div class="tbl-scroll">
                <table class="reprice-preview-table">
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="reprice-check-all" onchange="toggleAllRepriceChecks(this.checked)" style="cursor:pointer;accent-color:var(--teal-bright);width:16px;height:16px;"></th>
                      <th>Product</th>
                      <th>Category</th>
                      <th>Variant</th>
                      <th>Current Price</th>
                      <th>New Price</th>
                      <th class="change-col">Change (‚Ç¶)</th>
                      <th>% Change</th>
                    </tr>
                  </thead>
                  <tbody id="reprice-preview-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Missing cost data section -->
          <div class="missing-cost-section" id="reprice-missing-section" style="display:none;">
            <h4>‚ö†Ô∏è Missing Cost Data ‚Äî these products will NOT be updated</h4>
            <p style="font-size:12px;color:var(--muted2);margin-bottom:12px;">Add <strong>Factory Cost (CNY)</strong> in the product editor to include these in future repricing.</p>
            <div id="reprice-missing-list" style="display:flex;flex-direction:column;gap:6px;"></div>
          </div>

          <!-- Section C: Action Bar -->
          <div class="reprice-action-bar" id="reprice-action-bar" style="margin-top:16px;">
            <div class="reprice-summary" id="reprice-action-summary">
              <strong id="reprice-will-update">0</strong> products will be updated ¬∑
              <strong id="reprice-will-skip">0</strong> skipped (no cost data) ¬∑
              Estimated time: instant
            </div>
            <button class="btn btn-primary" style="font-size:14px;padding:12px 24px;" onclick="applyReprice()">
              ‚ö° Apply New Rate &amp; Update All Prices
            </button>
          </div>

          <!-- Progress -->
          <div class="reprice-progress" id="reprice-progress" style="display:none;">
            <div style="font-size:15px;font-weight:700;color:var(--white);" id="reprice-progress-label">Updating prices‚Ä¶</div>
            <div class="progress-bar-wrap">
              <div class="progress-bar-fill" id="reprice-progress-bar" style="width:0%"></div>
            </div>
            <div style="font-size:12px;color:var(--muted2);" id="reprice-progress-detail">Preparing batch‚Ä¶</div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê REFERRALS PANEL ‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-referrals">
        <div class="section-header">
          <div class="section-title">Referral Tracker</div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;" id="ref-tier-stats"></div>
        <div class="section-header" style="margin-top:8px">
          <div class="section-title" style="font-size:15px">Orders with Referral Codes</div>
        </div>
        <div class="table-wrap">
          <div class="tbl-scroll">
            <table>
              <thead>
                <tr><th>Referrer Name</th><th>Order Ref</th><th>Customer</th><th>Order Value</th><th>Reward Tier</th><th>Status</th><th>Date</th></tr>
              </thead>
              <tbody id="ref-tbody">
                <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:40px">Loading referral data‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê -->
      <div class="panel" id="panel-settings">
        <div class="settings-grid">

          <!-- Exchange Rate Control (NEW) -->
          <div class="settings-section" style="border-color:#0D8A7240;">
            <h3>üí± Exchange Rate Control</h3>
            <div class="form-group">
              <label class="form-label">Current Rate (‚Ç¶ per ¬•1 CNY)</label>
              <input class="form-input" type="number" id="s-exchange-rate" placeholder="e.g. 220" oninput="">
              <div style="font-size:11px;color:var(--muted);margin-top:4px;">Update every Monday morning before repricing</div>
            </div>
            <div style="background:var(--ink2);border-radius:6px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:var(--muted2);">
              Last updated: <span id="s-rate-last-updated" style="color:var(--white);">‚Äî</span>
            </div>
            <div style="background:rgba(220,38,38,.08);border:1px solid rgba(220,38,38,.2);border-radius:8px;padding:10px 14px;font-size:12px;color:#f87171;margin-bottom:16px;">
              ‚ö†Ô∏è Saving a new rate here does NOT automatically update product prices. Use the <strong>üí± Bulk Reprice</strong> panel after updating.
            </div>
            <button class="btn btn-primary btn-full" onclick="saveExchangeRate()">üíæ Save Exchange Rate</button>
          </div>

          <!-- Site Announcements -->
          <div class="settings-section">
            <h3>üì£ Announcement Bar</h3>
            <div class="form-group">
              <label class="form-label">Announcement Text</label>
              <textarea class="form-input" id="s-ann" rows="3" placeholder="‚ö° Round 2 LIVE ‚Äî 7 Slots Remaining‚Ä¶"></textarea>
            </div>
            <button class="btn btn-primary btn-full" onclick="saveSetting('announcementText', document.getElementById('s-ann').value)">Save Announcement</button>
          </div>

          <!-- Urgency Slots -->
          <div class="settings-section">
            <h3>‚ö° Urgency Slots</h3>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Total Slots</label>
                <input class="form-input" type="number" id="s-slots-total" placeholder="15">
              </div>
              <div class="form-group">
                <label class="form-label">Remaining Slots</label>
                <input class="form-input" type="number" id="s-slots-rem" placeholder="7">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Countdown Deadline</label>
              <input class="form-input" type="datetime-local" id="s-deadline">
            </div>
            <button class="btn btn-primary btn-full" onclick="saveUrgency()">Update Urgency</button>
          </div>

          <!-- Delivery Fees -->
          <div class="settings-section">
            <h3>üöö Delivery Fees</h3>
            <div class="form-group">
              <label class="form-label">Port Harcourt Fee (‚Ç¶)</label>
              <input class="form-input" type="number" id="s-fee-ph" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">South-South / South-East Fee (‚Ç¶)</label>
              <input class="form-input" type="number" id="s-fee-other" placeholder="5000">
            </div>
            <div class="form-group">
              <label class="form-label">Lagos / Abuja Fee (‚Ç¶)</label>
              <input class="form-input" type="number" id="s-fee-lagos" placeholder="7500">
            </div>
            <div class="form-group">
              <label class="form-label">Northern States Fee (‚Ç¶)</label>
              <input class="form-input" type="number" id="s-fee-north" placeholder="9000">
            </div>
            <button class="btn btn-primary btn-full" onclick="saveDeliveryFees()">Save Delivery Fees</button>
          </div>

          <!-- Site Controls -->
          <div class="settings-section">
            <h3>üîß Site Controls</h3>
            <div class="toggle-wrap">
              <div>
                <div class="toggle-label">Accepting Orders</div>
                <div class="toggle-sub">Disables checkout when off</div>
              </div>
              <label class="toggle"><input type="checkbox" id="s-accepting" onchange="saveSetting('acceptingOrders',this.checked)"><span class="toggle-track"></span></label>
            </div>
            <div class="toggle-wrap">
              <div>
                <div class="toggle-label">Maintenance Mode</div>
                <div class="toggle-sub">Shows maintenance page</div>
              </div>
              <label class="toggle"><input type="checkbox" id="s-maintenance" onchange="saveSetting('maintenanceMode',this.checked)"><span class="toggle-track"></span></label>
            </div>
            <div class="form-group" style="margin-top:16px">
              <label class="form-label">WhatsApp Number</label>
              <input class="form-input" type="tel" id="s-wa" placeholder="2348142717585">
            </div>
            <div class="form-group">
              <label class="form-label">Current Round Label</label>
              <input class="form-input" type="text" id="s-round" placeholder="Round 2">
            </div>
            <button class="btn btn-primary btn-full" onclick="saveSiteControls()">Save Settings</button>
          </div>

        </div>
      </div>

    </div><!-- end #content -->
  </div><!-- end #main -->
</div><!-- end #app -->

<!-- ‚ïê‚ïê‚ïê PRODUCT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-bg" id="product-modal">
  <div class="modal-box" style="max-width:700px;">
    <div class="modal-header">
      <div class="modal-title" id="prod-modal-title">Add New Product</div>
      <button class="modal-close" onclick="closeProductModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pm-id">

      <!-- Basic Info -->
      <div class="form-row" style="margin-bottom:16px">
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Product Name *</label>
          <input class="form-input" id="pm-name" placeholder="iPhone 15 Pro Max 256GB">
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Category *</label>
          <select class="form-select" id="pm-cat" onchange="onPmCatChange()">
            <option value="tech">üì± Tech &amp; Gadgets</option>
            <option value="fashion">üëú Fashion</option>
            <option value="shoes">üëü Shoes</option>
            <option value="bags">üëú Bags</option>
            <option value="watches">‚åö Watches</option>
            <option value="perfume">üå∏ Perfumes</option>
            <option value="skincare">‚ú® Skincare</option>
            <option value="gaming">üéÆ Gaming</option>
            <option value="jewelry">üíç Jewelry</option>
            <option value="kids">üß∏ Kids</option>
            <option value="sports">üí™ Sports</option>
            <option value="home">üè† Home</option>
            <option value="general">üì¶ General</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Short Spec / Subtitle</label>
        <input class="form-input" id="pm-spec" placeholder="6.7&quot; Super Retina XDR ¬∑ A17 Pro ¬∑ 48MP Camera">
      </div>

      <div class="form-row" style="margin-bottom:16px">
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Icon Emoji</label>
          <input class="form-input" id="pm-icon" placeholder="üì±" style="font-size:20px;text-align:center;" maxlength="4">
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Sort Order (lower = first)</label>
          <input class="form-input" type="number" id="pm-sort" placeholder="1">
        </div>
      </div>

      <!-- ‚îÄ‚îÄ COST & SOURCING (NEW) ‚îÄ‚îÄ -->
      <div style="background:linear-gradient(135deg,#0D8A7215,#0B6E5C0a);border:1px solid #0D8A7230;border-radius:var(--radius);padding:16px;margin-bottom:16px;">
        <div style="font-size:12px;font-weight:700;color:var(--teal-bright);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px;">üßÆ Costing &amp; Auto-Pricing</div>
        <div class="form-row" style="margin-bottom:12px;">
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">Factory Cost (CNY ¬•)</label>
            <input class="form-input" type="number" id="pm-cost-cny" placeholder="e.g. 4800" oninput="updatePmSuggestedPrice()">
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">Sourcing Method</label>
            <select class="form-select" id="pm-source-method" onchange="updatePmSuggestedPrice()">
              <option value="agent">Via Agent (√ó1.06)</option>
              <option value="direct">Direct 1688 (no agent fee)</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Category Multiplier <span style="color:var(--muted);font-weight:400;font-size:11px;">(auto-filled by category, override allowed)</span></label>
          <input class="form-input" type="number" id="pm-cat-multiplier" placeholder="e.g. 1.65" step="0.01" oninput="updatePmSuggestedPrice()">
        </div>
        <div id="pm-suggested-price-hint" style="display:none;" class="suggested-price-hint">
          üí° Suggested Price at current rate: <strong id="pm-suggested-price-val">‚Ç¶0</strong>
        </div>
      </div>

      <!-- Base Price -->
      <div class="form-group">
        <label class="form-label">Base Price (‚Ç¶) ‚Äî used if no variant prices set</label>
        <input class="form-input" type="number" id="pm-price" placeholder="895000" oninput="calcSuggestedMargin()">
        <div id="pm-margin-hint" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      </div>

      <!-- ‚îÄ‚îÄ VARIANT PRICES (New Two-Tier System) ‚îÄ‚îÄ -->
      <div class="form-group">
        <label class="form-label" style="display:flex;align-items:center;justify-content:space-between">
          <span>Storage / Model Variants with Prices</span>
          <button type="button" class="btn btn-outline btn-sm" onclick="addVariantPriceRow()">+ Add</button>
        </label>
        <div style="display:grid;grid-template-columns:1fr 130px 110px auto;gap:6px;align-items:center;margin-bottom:4px;padding:0 2px;">
          <span style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;">Label</span>
          <span style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;">Price (‚Ç¶)</span>
          <span style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;">Cost (CNY)</span>
          <span></span>
        </div>
        <div id="variant-prices-container" style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px;"></div>
        <div style="font-size:11px;color:var(--muted)">Each entry = a separate price tier (e.g. 256GB, 512GB). Add CNY cost per tier for accurate bulk repricing.</div>
      </div>

      <!-- ‚îÄ‚îÄ COLORS (Free choice, no price change) ‚îÄ‚îÄ -->
      <div class="form-group">
        <label class="form-label" style="display:flex;align-items:center;justify-content:space-between">
          <span>Color Options (no price change)</span>
          <button type="button" class="btn btn-outline btn-sm" onclick="addColorRow()">+ Add Color</button>
        </label>
        <div id="colors-container" style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px;"></div>
        <div style="font-size:11px;color:var(--muted)">Color/variant labels customers choose freely (e.g. Natural Titanium, Blue Titanium).</div>
      </div>

      <!-- ‚îÄ‚îÄ LEGACY VARIANTS (kept for backward compat) ‚îÄ‚îÄ -->
      <div class="form-group">
        <label class="form-label" style="display:flex;align-items:center;justify-content:space-between">
          <span>Legacy Flat Variants (optional)</span>
          <button type="button" class="btn btn-outline btn-sm" onclick="addLegacyVariantRow()">+ Add</button>
        </label>
        <div id="legacy-variants-container" style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px;"></div>
        <div style="font-size:11px;color:var(--muted)">Old-style flat list (Black, White‚Ä¶) ‚Äî only used if no variant prices above.</div>
      </div>

      <!-- ‚îÄ‚îÄ PRODUCT IMAGES (multi-image) ‚îÄ‚îÄ -->
      <div class="form-group">
        <label class="form-label">Product Images (up to 8) ‚Äî First image = Primary</label>

        <!-- Cloudinary instruction banner -->
        <div style="background:linear-gradient(135deg,#0D8A7215,#0B6E5C0a);border:1px solid #0D8A7240;border-radius:var(--radius);padding:14px 16px;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            <span style="font-size:20px;">‚òÅÔ∏è</span>
            <div>
              <div style="font-size:13px;font-weight:700;color:var(--teal-bright);">Use Cloudinary to host your images</div>
              <div style="font-size:11px;color:var(--muted2);margin-top:1px;">Upload photos at <strong style="color:var(--white)">cloudinary.com</strong> ‚Üí copy the <code style="color:var(--gold-bright)">res.cloudinary.com/...</code> URL ‚Üí paste below</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;font-size:11px;color:var(--muted2);">
            <div>‚úÖ &nbsp;Use URL starting with <code style="color:#4ade80">res.cloudinary.com/...</code></div>
            <div>‚ùå &nbsp;Never use <code style="color:#f87171">collection.cloudinary.com/...</code> ‚Äî expires in 7 days</div>
            <div>‚ùå &nbsp;Do not use the drag/upload box below ‚Äî Firebase Storage not active</div>
          </div>
        </div>

        <!-- URL Paste ‚Äî PRIMARY METHOD -->
        <div style="background:var(--card2);border:1px solid #ffffff10;border-radius:var(--radius);padding:16px;margin-bottom:12px;">
          <div style="font-size:12px;font-weight:700;color:var(--white);margin-bottom:10px;">üìã Paste Cloudinary URL</div>
          <div style="display:flex;gap:8px;">
            <input class="form-input" id="pm-img-url" placeholder="https://res.cloudinary.com/yourname/image/upload/v.../photo.jpg" style="flex:1">
            <button type="button" class="btn btn-primary btn-sm" onclick="addImageUrl()">‚ûï Add</button>
          </div>
          <div style="font-size:11px;color:var(--muted);margin-top:8px;">Paste one URL at a time and click Add. Repeat for each photo (up to 8 total).</div>
        </div>

        <!-- Image previews -->
        <div class="img-preview-grid" id="img-preview-grid"></div>
        <div id="img-count-hint" style="font-size:11px;color:var(--muted);margin-top:6px;display:none;"></div>

        <!-- Disabled upload box ‚Äî visible but blocked -->
        <details style="margin-top:12px;">
          <summary style="font-size:11px;color:var(--muted);cursor:pointer;user-select:none;">‚ö†Ô∏è Direct upload (disabled ‚Äî Firebase Storage not active)</summary>
          <div style="margin-top:8px;position:relative;">
            <!-- Overlay to block clicks -->
            <div style="position:absolute;inset:0;z-index:10;background:rgba(8,9,12,0.7);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;cursor:not-allowed;">
              <div style="text-align:center;">
                <div style="font-size:22px;margin-bottom:4px;">üîí</div>
                <div style="font-size:12px;font-weight:700;color:#f87171;">Firebase Storage Not Active</div>
                <div style="font-size:11px;color:var(--muted2);margin-top:2px;">Use Cloudinary URL paste above</div>
              </div>
            </div>
            <div class="img-upload-wrap" style="opacity:0.3;pointer-events:none;">
              <div style="font-size:28px;margin-bottom:8px">üñºÔ∏è</div>
              <div style="font-size:13px;font-weight:600;color:var(--muted2)">Click or drag images here</div>
              <div style="font-size:11px;color:var(--muted);margin-top:4px">Disabled ‚Äî use URL paste above</div>
            </div>
          </div>
        </details>
        <input type="file" id="img-file-input" accept="image/*" multiple style="display:none" onchange="handleImgSelect(this.files)">
      </div>

      <!-- ‚îÄ‚îÄ FULL DESCRIPTION (SEO) ‚îÄ‚îÄ -->
      <div class="form-group">
        <label class="form-label">Full Product Description (SEO)</label>
        <textarea class="form-input" id="pm-description" rows="6"
          placeholder="Full product details, key specs, why buy from GGS, authenticity notes, compatibility info, FAQs about this product‚Ä¶"></textarea>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">Displayed in the product detail modal. Supports line breaks. Used for SEO content.</div>
      </div>

      <!-- ‚îÄ‚îÄ SEO META DESCRIPTION ‚îÄ‚îÄ -->
      <div class="form-group">
        <label class="form-label">SEO Meta Description (160 chars max)</label>
        <input class="form-input" id="pm-seo-meta" maxlength="200"
          placeholder="Buy authentic iPhone 15 Pro Max in Nigeria at factory cost price. 256GB/512GB/1TB. A17 Pro. Flutterwave secure checkout."
          oninput="updateSeoCounter(this)">
        <div class="char-counter" id="seo-char-counter">0 / 160</div>
      </div>

      <!-- Badge & Status -->
      <div class="form-row" style="margin-bottom:16px">
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Badge</label>
          <select class="form-select" id="pm-badge">
            <option value="">None</option>
            <option value="hot">üî• HOT</option>
            <option value="new">‚ú® NEW</option>
            <option value="pick">‚≠ê TOP PICK</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Badge Label Text</label>
          <input class="form-input" id="pm-badge-text" placeholder="HOT DEAL / New Arrival">
        </div>
      </div>

      <div class="toggle-wrap">
        <div>
          <div class="toggle-label">Product Active (visible on site)</div>
          <div class="toggle-sub">Uncheck to hide from catalog without deleting</div>
        </div>
        <label class="toggle"><input type="checkbox" id="pm-active" checked><span class="toggle-track"></span></label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeProductModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProduct()">üíæ Save Product</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ORDER DETAIL MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-bg" id="order-modal">
  <div class="modal-box" style="max-width:580px;">
    <div class="modal-header">
      <div class="modal-title">Order Details</div>
      <button class="modal-close" onclick="document.getElementById('order-modal').classList.remove('open')">‚úï</button>
    </div>
    <div class="modal-body" id="order-modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="document.getElementById('order-modal').classList.remove('open')">Close</button>
      <button class="btn btn-primary" onclick="sendOrderUpdateWA()">üí¨ WhatsApp Customer</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="admin-toast"></div>

<!-- FIREBASE + APP SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
  onSnapshot, serverTimestamp, query, orderBy, limit, getDoc, writeBatch
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getStorage, ref as stRef, uploadString, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey:"AIzaSyCGU14FHH82Ja5Bx9ZE3ImlePoyKvZLdYg",
  authDomain:"ggs-global.firebaseapp.com",
  projectId:"ggs-global",
  storageBucket:"ggs-global.firebasestorage.app",
  messagingSenderId:"688407888100",
  appId:"1:688407888100:web:a9f3e068ca9624e3b66cf1"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const storage = getStorage(app);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt = n => '‚Ç¶' + Number(n||0).toLocaleString('en-NG');
function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function toast(msg, isErr=false){
  const t = document.getElementById('admin-toast');
  t.textContent = msg;
  t.className = 'show' + (isErr ? ' error' : '');
  clearTimeout(t._t);
  t._t = setTimeout(()=>{ t.className=''; }, 3200);
}

// Category multiplier map
const CAT_MULTIPLIERS = {
  tech: 1.65, fashion: 1.78, shoes: 1.80, bags: 1.78,
  watches: 1.72, perfume: 1.82, skincare: 1.82, gaming: 1.70,
  jewelry: 1.82, kids: 1.75, sports: 1.78, home: 1.78, general: 1.78
};

function calcListingPrice(costCNY, rate, sourceMethod, multiplier){
  if(!costCNY || !rate || !multiplier) return 0;
  let p = costCNY * rate;
  p *= 1.15;
  if(sourceMethod === 'agent') p *= 1.06;
  p *= 1.08;
  p *= 1.014;
  p *= multiplier;
  return Math.ceil(p / 5000) * 5000;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AUTH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.doLogin = async function(){
  const email = document.getElementById('au-email').value.trim();
  const pass  = document.getElementById('au-pass').value;
  const errEl = document.getElementById('auth-error');
  errEl.textContent = '';
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    errEl.textContent = 'Invalid credentials. Please try again.';
  }
};
window.doLogout = ()=> signOut(auth);

onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').classList.add('visible');
    document.getElementById('adminEmailDisplay').textContent = user.email;
    initDashboard();
  } else {
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('app').classList.remove('visible');
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NAVIGATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PANEL_TITLES = {
  overview:'Overview', orders:'Orders', products:'Products',
  categories:'Categories', pricing:'Pricing Calculator',
  reprice:'Bulk Reprice Engine',
  referrals:'Referral Tracker', settings:'Site Settings'
};
window.navTo = function(panel, el){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const target = document.getElementById('panel-'+panel);
  if(target) target.classList.add('active');
  if(el){ el.classList.add('active'); }
  else {
    const navEl = document.querySelector(`.nav-item[data-panel="${panel}"]`);
    if(navEl) navEl.classList.add('active');
  }
  document.getElementById('topbarTitle').textContent = PANEL_TITLES[panel]||panel;
  closeSidebar();
  if(panel === 'reprice') renderRepricePanelRate();
  if(panel === 'pricing') syncCalcRateFromSettings();
};
window.toggleSidebar = function(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('show');
};
window.closeSidebar = function(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('show');
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DATA STORES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _allOrders   = [];
let _allProducts = [];
let _settings    = {};
let _orderFilter = 'all';
let _orderPage   = 0;
const PAGE_SIZE  = 20;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT LISTENERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initDashboard(){
  // Orders listener
  onSnapshot(query(collection(db,'orders'), orderBy('createdAt','desc')), snap=>{
    _allOrders = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderOverviewOrders();
    renderOrders();
    renderReferrals();
    updateStatsFromOrders();
  }, err=>console.error('Orders error:',err));

  // Products listener
  onSnapshot(collection(db,'products'), snap=>{
    _allProducts = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderProducts();
    renderCategories();
    updateProductStat();
  }, err=>console.error('Products error:',err));

  // Settings listener
  onSnapshot(doc(db,'settings','site-config'), snap=>{
    if(!snap.exists()) return;
    _settings = snap.data();
    applySettings(_settings);
    updateCalcStoredRateDisplay();
    renderRepricePanelRate();
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStatsFromOrders(){
  const total    = _allOrders.reduce((s,o)=>s+(o.totalPaid||0),0);
  const pending  = _allOrders.filter(o=>o.orderStatus==='processing'||o.orderStatus==='shipped').length;
  const thisMonth= _allOrders.filter(o=>{
    if(!o.createdAt?.toDate) return false;
    const d=o.createdAt.toDate(); const now=new Date();
    return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
  }).length;
  document.getElementById('stat-revenue').textContent = fmt(total);
  document.getElementById('stat-revenue-sub').textContent = `${_allOrders.length} paid orders`;
  document.getElementById('stat-orders').textContent = _allOrders.length;
  document.getElementById('stat-orders-sub').textContent = `${thisMonth} this month`;
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('pendingBadge').textContent = pending;
}
function updateProductStat(){
  const active = _allProducts.filter(p=>p.active!==false).length;
  document.getElementById('stat-products').textContent = active;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// OVERVIEW ORDERS TABLE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverviewOrders(){
  const tbody = document.getElementById('overview-orders-tbody');
  const recent = _allOrders.slice(0,8);
  if(!recent.length){ tbody.innerHTML=`<tr><td colspan="8" class="empty-state" style="padding:30px;color:var(--muted)">No orders yet.</td></tr>`; return; }
  tbody.innerHTML = recent.map(o=>`
    <tr>
      <td><code style="font-size:11px;color:var(--gold)">${escHtml(o.txRef||o.id)}</code></td>
      <td><strong>${escHtml((o.customer?.firstName||'')+' '+(o.customer?.lastName||''))}</strong></td>
      <td>${escHtml((o.items||[]).map(i=>`${i.name}√ó${i.qty}`).join(', ').substring(0,40))}</td>
      <td><strong style="color:var(--gold-bright)">${fmt(o.totalPaid)}</strong></td>
      <td style="max-width:120px;white-space:normal;font-size:11px">${escHtml(o.shippingMethod||'‚Äî')}</td>
      <td>${statusBadge(o.orderStatus)}</td>
      <td style="color:var(--muted2);font-size:11px">${formatDate(o.createdAt)}</td>
      <td><select class="status-select" onchange="updateOrderStatus('${escHtml(o.id)}',this.value)">
        <option value="processing" ${o.orderStatus==='processing'?'selected':''}>üîÑ Processing</option>
        <option value="shipped"    ${o.orderStatus==='shipped'?'selected':''}>‚úàÔ∏è Shipped</option>
        <option value="delivered"  ${o.orderStatus==='delivered'?'selected':''}>‚úÖ Delivered</option>
      </select></td>
    </tr>`).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ORDERS TABLE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getFilteredOrders(){
  const q = (document.getElementById('order-search')?.value||'').toLowerCase().trim();
  return _allOrders.filter(o=>{
    const statusMatch = _orderFilter==='all' || o.orderStatus===_orderFilter;
    if(!statusMatch) return false;
    if(!q) return true;
    const name  = ((o.customer?.firstName||'')+' '+(o.customer?.lastName||'')).toLowerCase();
    const ref   = (o.txRef||'').toLowerCase();
    const phone = (o.customer?.phone||'').toLowerCase();
    const state = (o.customer?.state||'').toLowerCase();
    return name.includes(q)||ref.includes(q)||phone.includes(q)||state.includes(q);
  });
}
window.filterOrders = function(status, el){
  _orderFilter = status;
  _orderPage   = 0;
  document.querySelectorAll('#order-filter-tabs .filter-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  renderOrders();
};
window.renderOrders = function(){
  const filtered = getFilteredOrders();
  const start    = _orderPage * PAGE_SIZE;
  const page     = filtered.slice(start, start+PAGE_SIZE);
  const tbody    = document.getElementById('orders-tbody');
  if(!page.length){ tbody.innerHTML=`<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:40px">No orders found.</td></tr>`; renderPagination(0,0); return; }
  tbody.innerHTML = page.map(o=>`
    <tr>
      <td><code style="font-size:11px;color:var(--gold)">${escHtml(o.txRef||o.id)}</code></td>
      <td><strong>${escHtml((o.customer?.firstName||'')+' '+(o.customer?.lastName||''))}</strong><br><span style="font-size:11px;color:var(--muted2)">${escHtml(o.customer?.email||'')}</span></td>
      <td>${escHtml(o.customer?.phone||'‚Äî')}</td>
      <td>${escHtml(o.customer?.state||'‚Äî')}</td>
      <td style="max-width:180px;white-space:normal;font-size:11px">${escHtml((o.items||[]).map(i=>`${i.name}√ó${i.qty}(${i.variant||''})`).join(', ').substring(0,80))}</td>
      <td><strong style="color:var(--gold-bright)">${fmt(o.totalPaid)}</strong></td>
      <td style="font-size:11px;max-width:100px;white-space:normal">${escHtml(o.shippingMethod||'‚Äî')}</td>
      <td><select class="status-select" onchange="updateOrderStatus('${escHtml(o.id)}',this.value)">
        <option value="processing" ${o.orderStatus==='processing'?'selected':''}>üîÑ Processing</option>
        <option value="shipped"    ${o.orderStatus==='shipped'?'selected':''}>‚úàÔ∏è Shipped</option>
        <option value="delivered"  ${o.orderStatus==='delivered'?'selected':''}>‚úÖ Delivered</option>
      </select></td>
      <td style="color:var(--muted2);font-size:11px">${formatDate(o.createdAt)}</td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="openOrderDetail('${escHtml(o.id)}')">View</button>
      </td>
    </tr>`).join('');
  renderPagination(filtered.length, _orderPage);
};
function renderPagination(total, cur){
  const pages = Math.ceil(total/PAGE_SIZE);
  const el    = document.getElementById('orders-pagination');
  if(!el) return;
  if(pages<=1){ el.innerHTML=''; return; }
  let html = '';
  for(let i=0;i<pages;i++){
    html += `<button class="btn btn-sm ${i===cur?'btn-primary':'btn-outline'}" onclick="goPage(${i})">${i+1}</button>`;
  }
  el.innerHTML = html;
}
window.goPage = function(n){ _orderPage=n; renderOrders(); };

window.updateOrderStatus = async function(id, status){
  try {
    await updateDoc(doc(db,'orders',id),{ orderStatus:status });
    toast('‚úÖ Order status updated');
  } catch(e){ toast('Error: '+e.message, true); }
};

window.openOrderDetail = function(id){
  const o = _allOrders.find(x=>x.id===id);
  if(!o) return;
  const body = document.getElementById('order-modal-body');
  body.innerHTML = `
    <div style="display:grid;gap:12px">
      <div style="background:var(--ink2);border-radius:10px;padding:16px">
        <div style="font-size:11px;color:var(--muted2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">Customer</div>
        <div><strong>${escHtml((o.customer?.firstName||'')+' '+(o.customer?.lastName||''))}</strong></div>
        <div style="font-size:12px;color:var(--muted2)">${escHtml(o.customer?.email||'')} ¬∑ ${escHtml(o.customer?.phone||'')}</div>
        <div style="font-size:12px;color:var(--muted2);margin-top:4px">${escHtml(o.customer?.address||'')} ¬∑ ${escHtml(o.customer?.state||'')}</div>
      </div>
      <div style="background:var(--ink2);border-radius:10px;padding:16px">
        <div style="font-size:11px;color:var(--muted2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">Items Ordered</div>
        ${(o.items||[]).map(i=>`<div style="display:flex;justify-content:space-between;font-size:13px;padding:5px 0;border-bottom:1px solid #ffffff06"><span>${escHtml(i.name)} √ó ${i.qty} <span style="color:var(--muted2)">(${escHtml(i.variant||'')})</span></span><strong style="color:var(--gold-bright)">${fmt(i.price*i.qty)}</strong></div>`).join('')}
        <div style="display:flex;justify-content:space-between;margin-top:10px;font-weight:700"><span>Total Paid</span><span style="color:var(--teal-bright)">${fmt(o.totalPaid)}</span></div>
      </div>
      <div style="background:var(--ink2);border-radius:10px;padding:16px">
        <div style="font-size:11px;color:var(--muted2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">Order Info</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
          <div><span style="color:var(--muted2)">Ref:</span> <code style="color:var(--gold)">${escHtml(o.txRef||o.id)}</code></div>
          <div><span style="color:var(--muted2)">Shipping:</span> ${escHtml(o.shippingMethod||'‚Äî')}</div>
          <div><span style="color:var(--muted2)">Status:</span> ${statusBadge(o.orderStatus)}</div>
          <div><span style="color:var(--muted2)">Date:</span> ${formatDate(o.createdAt)}</div>
          ${o.referralCode?`<div><span style="color:var(--muted2)">Referral:</span> <strong style="color:var(--gold-bright)">${escHtml(o.referralCode)}</strong></div>`:''}
        </div>
      </div>
      <div>
        <label class="form-label">Update Order Status</label>
        <select class="form-select" id="od-status-sel">
          <option value="processing" ${o.orderStatus==='processing'?'selected':''}>üîÑ Processing</option>
          <option value="shipped"    ${o.orderStatus==='shipped'?'selected':''}>‚úàÔ∏è Shipped to Nigeria</option>
          <option value="delivered"  ${o.orderStatus==='delivered'?'selected':''}>‚úÖ Delivered</option>
        </select>
        <button class="btn btn-primary btn-full" style="margin-top:8px" onclick="updateOrderStatus('${escHtml(o.id)}',document.getElementById('od-status-sel').value)">Update Status</button>
      </div>
    </div>`;
  document.getElementById('order-modal')._orderId = id;
  document.getElementById('order-modal').classList.add('open');
};

window.sendOrderUpdateWA = function(){
  const id = document.getElementById('order-modal')?._orderId;
  const o  = id ? _allOrders.find(x=>x.id===id) : null;
  if(!o) return;
  const status = document.getElementById('od-status-sel')?.value || o.orderStatus;
  const msgs = {
    shipped:   `Hi ${o.customer?.firstName||'there'} üëã\nGreat news! Your GGS order has shipped from China and is on its way to Nigeria.\n\nOrder Ref: ${o.txRef||o.id}\nShipping method: ${o.shippingMethod||''}\n\nWe'll update you when goods arrive in Nigeria. Thanks for your patience! üöö`,
    delivered: `Hi ${o.customer?.firstName||'there'} üëãüéâ\nYour GGS order has been delivered!\n\nOrder Ref: ${o.txRef||o.id}\nItems: ${(o.items||[]).map(i=>i.name).join(', ')}\n\nPlease confirm you received everything perfectly. We'd love a review! üôè`,
    processing:`Hi ${o.customer?.firstName||'there'} üëã\nYour GGS order is confirmed!\n\nOrder Ref: ${o.txRef||o.id}\nTotal Paid: ${fmt(o.totalPaid)}\nItems: ${(o.items||[]).map(i=>i.name).join(', ')}\n\nWe're sourcing your items now. Expect WhatsApp updates every 5‚Äì7 days. üì¶`
  };
  const msg = msgs[status] || msgs.processing;
  const phone = (o.customer?.phone||'').replace(/\D/g,'').replace(/^0/,'234');
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
  document.getElementById('order-modal').classList.remove('open');
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EXPORT CSV
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.exportOrdersCSV = function(){
  const rows = [['Ref','First Name','Last Name','Email','Phone','State','Address','Items','Total','Shipping','Status','Referral','Date']];
  _allOrders.forEach(o=>{
    rows.push([
      o.txRef||o.id,
      o.customer?.firstName||'', o.customer?.lastName||'',
      o.customer?.email||'', o.customer?.phone||'',
      o.customer?.state||'', o.customer?.address||'',
      (o.items||[]).map(i=>`${i.name}x${i.qty}`).join(';'),
      o.totalPaid||0, o.shippingMethod||'',
      o.orderStatus||'', o.referralCode||'',
      formatDate(o.createdAt)
    ]);
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a   = document.createElement('a');
  a.href    = 'data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download= `GGS-Orders-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PRODUCTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.renderProducts = function(){
  const q    = (document.getElementById('prod-search')?.value||'').toLowerCase();
  const cat  = document.getElementById('prod-cat-filter')?.value||'';
  const list = _allProducts.filter(p=>{
    const mq = !q || (p.name||'').toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q);
    const mc = !cat || p.category===cat;
    return mq && mc;
  }).sort((a,b)=>(a.sortOrder||a.order||99)-(b.sortOrder||b.order||99));
  const tbody = document.getElementById('products-tbody');
  if(!list.length){ tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:40px">No products found.</td></tr>`; return; }

  tbody.innerHTML = list.map(p=>{
    const imgs  = p.images?.length ? p.images : (p.img ? [p.img] : []);
    const thumb = imgs[0] || '';
    const hasVP = Array.isArray(p.variantPrices) && p.variantPrices.length;
    const hasCL = Array.isArray(p.colors) && p.colors.length;
    const baseP = hasVP ? p.variantPrices[0].price : (p.price||0);
    const variantInfo = hasVP
      ? `<span style="color:var(--teal-bright);font-size:11px">${p.variantPrices.length} sizes</span>${hasCL?`<br><span style="font-size:10px;color:var(--muted2)">${p.colors.length} colors</span>`:''}`
      : (Array.isArray(p.variants)&&p.variants.length ? `<span style="font-size:11px;color:var(--muted2)">${p.variants.length} options</span>` : `<span style="color:var(--muted);font-size:11px">‚Äî</span>`);
    return `
    <tr>
      <td>
        <div class="prod-thumb-wrap">
          <div class="prod-thumb">${thumb?`<img src="${escHtml(thumb)}" alt="" onerror="this.parentElement.textContent='${escHtml(p.icon||'üì¶')}'">`:escHtml(p.icon||'üì¶')}</div>
          <div><div class="prod-name">${escHtml(p.name||'')}</div><div class="prod-spec">${escHtml((p.spec||'').substring(0,50))}</div></div>
        </div>
      </td>
      <td><span class="badge badge-muted">${escHtml(p.category||'general')}</span></td>
      <td><strong style="color:var(--gold-bright)">${fmt(baseP)}</strong>${hasVP?`<br><span style="font-size:10px;color:var(--muted)">from</span>`:''}${hasVP&&p.variantPrices.length>1?`<br><span style="font-size:10px;color:var(--muted2)">to ${fmt(p.variantPrices[p.variantPrices.length-1].price)}</span>`:''}</td>
      <td>${variantInfo}</td>
      <td>${p.badge?`<span class="badge badge-${p.badge==='hot'?'hot':p.badge==='new'?'new':'pick'}">${escHtml(p.badgeText||p.badge)}</span>`:'<span style="color:var(--muted)">‚Äî</span>'}</td>
      <td>${p.active===false?`<span class="badge badge-red">Hidden</span>`:`<span class="badge badge-teal">Active</span>`}</td>
      <td style="color:var(--muted2)">${p.sortOrder||p.order||'‚Äî'}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn btn-outline btn-sm" onclick="editProduct('${escHtml(p.id)}')">‚úèÔ∏è Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteProduct('${escHtml(p.id)}','${escHtml(p.name||'')}')">üóëÔ∏è</button>
        </div>
      </td>
    </tr>`;
  }).join('');
};

// ‚îÄ‚îÄ PRODUCT MODAL LOGIC ‚îÄ‚îÄ
let _editingProductId = null;
let _pmImages = []; // array of {src:string, isNew:bool}

// Category change handler ‚Äî auto-fill multiplier
window.onPmCatChange = function(){
  const cat = document.getElementById('pm-cat').value;
  const mult = CAT_MULTIPLIERS[cat] || 1.78;
  document.getElementById('pm-cat-multiplier').value = mult;
  updatePmSuggestedPrice();
};

// Live price preview in product modal
window.updatePmSuggestedPrice = function(){
  const cny  = Number(document.getElementById('pm-cost-cny').value||0);
  const meth = document.getElementById('pm-source-method').value;
  const mult = Number(document.getElementById('pm-cat-multiplier').value||0);
  const rate = Number(_settings.exchangeRate||220);
  const hint = document.getElementById('pm-suggested-price-hint');
  const val  = document.getElementById('pm-suggested-price-val');
  if(!cny || !mult || !rate){ if(hint) hint.style.display='none'; return; }
  const price = calcListingPrice(cny, rate, meth, mult);
  if(hint) hint.style.display='block';
  if(val)  val.textContent = fmt(price);
};

window.openProductModal = function(id){
  _editingProductId = id || null;
  _pmImages = [];

  // Reset form
  ['pm-name','pm-spec','pm-icon','pm-price','pm-badge-text','pm-img-url','pm-description','pm-seo-meta','pm-cost-cny'].forEach(f=>{
    const el=document.getElementById(f); if(el) el.value='';
  });
  document.getElementById('pm-sort').value='';
  document.getElementById('pm-cat').value='tech';
  document.getElementById('pm-badge').value='';
  document.getElementById('pm-active').checked=true;
  document.getElementById('pm-source-method').value='agent';
  document.getElementById('pm-cat-multiplier').value = CAT_MULTIPLIERS['tech']||1.65;
  document.getElementById('variant-prices-container').innerHTML='';
  document.getElementById('colors-container').innerHTML='';
  document.getElementById('legacy-variants-container').innerHTML='';
  document.getElementById('img-preview-grid').innerHTML='';
  document.getElementById('seo-char-counter').textContent='0 / 160';
  document.getElementById('seo-char-counter').className='char-counter';
  const hint = document.getElementById('pm-suggested-price-hint');
  if(hint) hint.style.display='none';

  if(id){
    const p = _allProducts.find(x=>x.id===id);
    if(!p) return;
    document.getElementById('prod-modal-title').textContent='Edit Product';
    document.getElementById('pm-id').value = id;
    document.getElementById('pm-name').value    = p.name||'';
    document.getElementById('pm-spec').value    = p.spec||'';
    document.getElementById('pm-icon').value    = p.icon||'';
    document.getElementById('pm-price').value   = p.price||'';
    document.getElementById('pm-sort').value    = p.sortOrder||p.order||'';
    document.getElementById('pm-cat').value     = p.category||'tech';
    document.getElementById('pm-badge').value   = p.badge||'';
    document.getElementById('pm-badge-text').value = p.badgeText||'';
    document.getElementById('pm-active').checked= p.active!==false;
    document.getElementById('pm-description').value = p.description||'';
    document.getElementById('pm-seo-meta').value    = p.seoMeta||'';
    document.getElementById('pm-cost-cny').value    = p.costCNY||'';
    document.getElementById('pm-source-method').value = p.sourceMethod||'agent';
    document.getElementById('pm-cat-multiplier').value = p.categoryMultiplier || CAT_MULTIPLIERS[p.category||'tech'] || 1.65;
    updateSeoCounter(document.getElementById('pm-seo-meta'));
    updatePmSuggestedPrice();

    // Images
    const imgs = p.images?.length ? p.images : (p.img?[p.img]:[]);
    _pmImages = imgs.map(s=>({src:s,isNew:false}));
    renderImgPreviews();

    // variantPrices
    if(Array.isArray(p.variantPrices)){
      p.variantPrices.forEach(vp=>addVariantPriceRow(vp.label, vp.price, vp.costCNY));
    }
    // colors
    if(Array.isArray(p.colors)){
      p.colors.forEach(c=>addColorRow(c));
    }
    // legacy variants
    if(Array.isArray(p.variants)){
      p.variants.forEach(v=>addLegacyVariantRow(v));
    }
  } else {
    document.getElementById('prod-modal-title').textContent='Add New Product';
    document.getElementById('pm-id').value='';
  }
  document.getElementById('product-modal').classList.add('open');
};
window.closeProductModal = function(){ document.getElementById('product-modal').classList.remove('open'); };
window.editProduct = function(id){ openProductModal(id); };

// Variant price rows ‚Äî now with costCNY column
window.addVariantPriceRow = function(label='', price='', costCNY=''){
  const c = document.getElementById('variant-prices-container');
  const d = document.createElement('div');
  d.className='variant-row';
  d.innerHTML=`
    <input type="text"   class="form-input vp-label" placeholder="e.g. 256GB" value="${escHtml(String(label))}">
    <input type="number" class="form-input vp-price v-price" placeholder="Price ‚Ç¶" value="${price?price:''}">
    <input type="number" class="form-input vp-cny v-cny" placeholder="CNY ¬•" value="${costCNY?costCNY:''}">
    <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">‚úï</button>`;
  c.appendChild(d);
};
// Color rows
window.addColorRow = function(val=''){
  const c = document.getElementById('colors-container');
  const d = document.createElement('div');
  d.className='color-row';
  d.innerHTML=`
    <input type="text" class="form-input color-val" placeholder="e.g. Natural Titanium" value="${escHtml(String(val))}">
    <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">‚úï</button>`;
  c.appendChild(d);
};
// Legacy variant rows
window.addLegacyVariantRow = function(val=''){
  const c = document.getElementById('legacy-variants-container');
  const d = document.createElement('div');
  d.className='variant-row';
  d.innerHTML=`
    <input type="text" class="form-input lv-val" placeholder="e.g. Black" value="${escHtml(String(val))}">
    <button type="button" class="btn btn-danger btn-icon btn-sm" onclick="this.parentElement.remove()">‚úï</button>`;
  c.appendChild(d);
};

// SEO counter
window.updateSeoCounter = function(el){
  const n = (el.value||'').length;
  const cnt = document.getElementById('seo-char-counter');
  if(!cnt) return;
  cnt.textContent = `${n} / 160`;
  cnt.className = 'char-counter' + (n>=160?' over':n>=140?' warn':'');
};

// Margin hint
window.calcSuggestedMargin = function(){
  const p = Number(document.getElementById('pm-price').value||0);
  const el = document.getElementById('pm-margin-hint');
  if(!el||!p) return;
  el.textContent = `Listing: ${fmt(p)} ¬∑ Est. margin ~18‚Äì25% depending on factory cost`;
};

// Image handling
function renderImgPreviews(){
  const grid = document.getElementById('img-preview-grid');
  grid.innerHTML = _pmImages.map((img,i)=>`
    <div class="img-preview-item${i===0?' primary-img':''}">
      <img src="${escHtml(img.src)}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\'><rect width=\'80\' height=\'80\' fill=\'%23161820\'/><text x=\'40\' y=\'44\' text-anchor=\'middle\' fill=\'%238C8898\' font-size=\'12\'>IMG</text></svg>'">
      <button class="img-del" onclick="removeImg(${i})">‚úï</button>
    </div>`).join('');
  updateImgCountHint();
}
function updateImgCountHint(){
  const hint = document.getElementById('img-count-hint');
  if(!hint) return;
  const count = _pmImages.length;
  if(count === 0){ hint.style.display='none'; return; }
  hint.style.display='block';
  const maxMsg = count>=8 ? ' ‚Äî <span style="color:#f87171">maximum reached</span>' : '';
  hint.innerHTML = `<span style="color:var(--teal-bright);font-weight:700;">${count}/8</span> images added${maxMsg}. <span style="color:var(--muted2)">First image = primary catalog photo.</span>`;
}
window.removeImg = function(i){
  _pmImages.splice(i,1);
  renderImgPreviews();
  updateImgCountHint();
};
window.addImageUrl = function(){
  const url = document.getElementById('pm-img-url').value.trim();
  if(!url){ toast('Please paste an image URL first', true); return; }
  if(_pmImages.length>=8){ toast('Maximum 8 images reached ‚Äî remove one first', true); return; }
  // Block expiring Cloudinary share links
  if(url.includes('collection.cloudinary.com')){
    toast('‚ö†Ô∏è That link expires in 7 days! Copy the res.cloudinary.com URL instead.', true);
    return;
  }
  // Warn if not a recognised image URL pattern (loose check)
  if(!url.startsWith('http')){
    toast('‚ö†Ô∏è URL must start with https://', true);
    return;
  }
  _pmImages.push({src:url, isNew:false});
  document.getElementById('pm-img-url').value='';
  renderImgPreviews();
  updateImgCountHint();
  toast(`‚úÖ Image ${_pmImages.length} added`);
};
window.handleImgDrop = function(e){
  e.preventDefault();
  toast('‚ö†Ô∏è Direct upload disabled. Use Cloudinary URL paste instead.', true);
};
window.handleImgSelect = function(files){
  toast('‚ö†Ô∏è Direct upload disabled. Use Cloudinary URL paste instead.', true);
};
function toBase64(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); }); }

// Save product
window.saveProduct = async function(){
  const name = document.getElementById('pm-name').value.trim();
  if(!name){ toast('Product name is required',true); return; }

  // Collect variantPrices (now includes costCNY per tier)
  const variantPrices = [];
  document.querySelectorAll('#variant-prices-container .variant-row').forEach(row=>{
    const label   = row.querySelector('.vp-label')?.value.trim();
    const price   = Number(row.querySelector('.vp-price')?.value||0);
    const vpCNY   = Number(row.querySelector('.vp-cny')?.value||0);
    if(label && price){
      const entry = {label,price};
      if(vpCNY) entry.costCNY = vpCNY;
      variantPrices.push(entry);
    }
  });
  // Collect colors
  const colors = [];
  document.querySelectorAll('#colors-container .color-val').forEach(el=>{ const v=el.value.trim(); if(v) colors.push(v); });
  // Collect legacy variants
  const variants = [];
  document.querySelectorAll('#legacy-variants-container .lv-val').forEach(el=>{ const v=el.value.trim(); if(v) variants.push(v); });

  // Upload new images to Firebase Storage
  const finalImages = [];
  for(const img of _pmImages){
    if(img.isNew && img.src.startsWith('data:')){
      try {
        const imgRef = stRef(storage, `products/${Date.now()}_${Math.random().toString(36).substr(2,6)}`);
        await uploadString(imgRef, img.src, 'data_url');
        const url = await getDownloadURL(imgRef);
        finalImages.push(url);
      } catch(e){ finalImages.push(img.src); }
    } else {
      finalImages.push(img.src);
    }
  }

  const basePrice = Number(document.getElementById('pm-price').value||0) ||
                    (variantPrices.length ? variantPrices[0].price : 0);

  const costCNY  = Number(document.getElementById('pm-cost-cny').value||0) || undefined;
  const catMult  = Number(document.getElementById('pm-cat-multiplier').value||0) || undefined;
  const srcMeth  = document.getElementById('pm-source-method').value || 'agent';

  const data = {
    name,
    category: (document.getElementById('pm-cat').value||'general').toLowerCase().trim(),
    spec:     document.getElementById('pm-spec').value.trim(),
    icon:     document.getElementById('pm-icon').value.trim()||'üì¶',
    price:    basePrice,
    sortOrder: Number(document.getElementById('pm-sort').value||99),
    badge:    document.getElementById('pm-badge').value,
    badgeText:document.getElementById('pm-badge-text').value.trim(),
    active:   document.getElementById('pm-active').checked,
    description: document.getElementById('pm-description').value.trim(),
    seoMeta:  document.getElementById('pm-seo-meta').value.trim(),
    sourceMethod: srcMeth,
    variantPrices,
    colors,
    variants,
    images:   finalImages,
    img:      finalImages[0]||'',
    updatedAt: serverTimestamp()
  };

  // Only set costCNY / categoryMultiplier if provided (don't overwrite with undefined)
  if(costCNY) data.costCNY = costCNY;
  if(catMult) data.categoryMultiplier = catMult;

  try {
    const existingId = document.getElementById('pm-id').value || _editingProductId;
    if(existingId){
      await updateDoc(doc(db,'products',existingId), data);
      toast('‚úÖ Product updated');
    } else {
      data.createdAt = serverTimestamp();
      await addDoc(collection(db,'products'), data);
      toast('‚úÖ Product added to catalog');
    }
    closeProductModal();
  } catch(e){ toast('Error: '+e.message, true); }
};

// Delete product
window.deleteProduct = async function(id, name){
  if(!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  try {
    await deleteDoc(doc(db,'products',id));
    toast('Product deleted');
  } catch(e){ toast('Error: '+e.message, true); }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CATEGORIES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CAT_META = {
  tech:    {label:'Tech & Gadgets',icon:'üì±'},
  fashion: {label:'Fashion',icon:'üëú'},
  shoes:   {label:'Shoes',icon:'üëü'},
  bags:    {label:'Bags',icon:'üëú'},
  watches: {label:'Watches',icon:'‚åö'},
  perfume: {label:'Perfumes',icon:'üå∏'},
  skincare:{label:'Skincare',icon:'‚ú®'},
  gaming:  {label:'Gaming',icon:'üéÆ'},
  jewelry: {label:'Jewelry',icon:'üíç'},
  kids:    {label:'Kids',icon:'üß∏'},
  sports:  {label:'Sports',icon:'üí™'},
  home:    {label:'Home',icon:'üè†'},
  general: {label:'General',icon:'üì¶'},
};
function renderCategories(){
  const grid = document.getElementById('cat-grid-container');
  if(!grid) return;
  const used = {};
  _allProducts.forEach(p=>{
    const cat = (p.category||'general').toLowerCase().trim();
    if(!used[cat]) used[cat]={total:0,active:0};
    used[cat].total++;
    if(p.active!==false) used[cat].active++;
  });
  const cats = Object.keys(used);
  if(!cats.length){ grid.innerHTML=`<div class="empty-state"><span class="empty-icon">üóÇÔ∏è</span><p>No categories yet. Add products to see categories.</p></div>`; return; }
  grid.innerHTML = cats.map(key=>{
    const m = CAT_META[key]||{label:key,icon:'üè∑Ô∏è'};
    const s = used[key];
    return `
    <div class="cat-chip">
      <div class="cat-chip-icon">${m.icon}</div>
      <div class="cat-chip-label">${m.label}</div>
      <div class="cat-chip-key">${key}</div>
      <div class="cat-chip-stats">
        <div class="cat-stat"><span>${s.active}</span> active</div>
        <div class="cat-stat"><span>${s.total}</span> total</div>
      </div>
      <button class="btn btn-outline btn-sm btn-full" onclick="document.getElementById('prod-cat-filter').value='${key}';navTo('products');renderProducts()">View Products ‚Üí</button>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PRICING CALCULATOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCalcStoredRateDisplay(){
  const rate = _settings.exchangeRate;
  if(!rate) return;
  const el = document.getElementById('calc-stored-rate-display');
  if(el) el.textContent = `‚Ç¶${Number(rate).toLocaleString('en-NG')} / ¬•1`;
}

window.syncCalcRateFromSettings = function(){
  const rate = _settings.exchangeRate;
  if(!rate){ toast('No exchange rate stored yet. Save one in Settings.', true); return; }
  const inp = document.getElementById('calc-rate');
  if(inp){ inp.value = rate; }
  runCalc();
  toast('‚úÖ Rate synced from settings: ‚Ç¶'+Number(rate).toLocaleString('en-NG'));
};

window.runCalc = function(){
  const cny    = Number(document.getElementById('calc-cny').value||0);
  const rate   = Number(document.getElementById('calc-rate').value||220);
  const source = document.getElementById('calc-source').value;
  const mult   = Number(document.getElementById('calc-cat').value||1.65);
  if(!cny){ document.getElementById('calc-result').style.display='none'; return; }

  const step1 = cny * rate;
  const step2 = step1 * 1.15;
  const step3 = source==='agent' ? step2*1.06 : step2;
  const step4 = step3 * 1.08;
  const step5 = step4 * 1.014;
  const step6 = step5 * mult;
  const final = Math.ceil(step6/5000)*5000;

  document.getElementById('calc-final').textContent = fmt(final);
  document.getElementById('calc-breakdown').innerHTML = `
    <div class="calc-line"><span>CNY ${cny} √ó ‚Ç¶${rate}</span><span>${fmt(step1)}</span></div>
    <div class="calc-line"><span>√ó 1.15 exchange buffer</span><span>${fmt(step2)}</span></div>
    ${source==='agent'?`<div class="calc-line"><span>√ó 1.06 agent fee</span><span>${fmt(step3)}</span></div>`:''}
    <div class="calc-line"><span>√ó 1.08 ops &amp; handling</span><span>${fmt(step4)}</span></div>
    <div class="calc-line"><span>√ó 1.014 Flutterwave fee</span><span>${fmt(step5)}</span></div>
    <div class="calc-line"><span>√ó ${mult} category multiplier</span><span>${fmt(step6)}</span></div>
    <div class="calc-line" style="color:var(--gold-bright);font-weight:700"><span>Ceil to nearest ‚Ç¶5,000</span><span>${fmt(final)}</span></div>`;
  document.getElementById('calc-result').style.display='block';
  document.getElementById('calc-result')._price = final;
};
window.useCalcPrice = function(){
  const price = document.getElementById('calc-result')._price;
  if(!price) return;
  navTo('products');
  openProductModal();
  setTimeout(()=>{ document.getElementById('pm-price').value=price; },100);
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BULK REPRICE ENGINE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _repriceRows = []; // computed rows for preview

function renderRepricePanelRate(){
  const rate    = _settings.exchangeRate;
  const updAt   = _settings.exchangeRateUpdatedAt;
  const rateEl  = document.getElementById('reprice-current-rate');
  const updEl   = document.getElementById('reprice-rate-updated');
  if(rateEl) rateEl.textContent = rate ? `‚Ç¶${Number(rate).toLocaleString('en-NG')}` : '‚Ç¶‚Äî';
  if(updEl){
    if(updAt?.toDate){
      updEl.textContent = 'Last updated: ' + updAt.toDate().toLocaleDateString('en-NG',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
    } else {
      updEl.textContent = 'Not yet set';
    }
  }
}

window.clearRepricePreview = function(){
  document.getElementById('reprice-preview-wrap').style.display='none';
  _repriceRows = [];
};

window.previewReprice = function(){
  const newRate = Number(document.getElementById('reprice-new-rate').value||0);
  if(!newRate || newRate < 1){ toast('Please enter a valid new exchange rate', true); return; }

  _repriceRows = [];
  const hasCostProducts  = [];
  const missingCostProducts = [];

  _allProducts.forEach(p=>{
    const hasVP = Array.isArray(p.variantPrices) && p.variantPrices.length;

    if(hasVP){
      // Check if any variant tier has costCNY
      let anyVarHasCost = false;
      p.variantPrices.forEach((vp,idx)=>{
        const vpCNY = vp.costCNY || p.costCNY; // fallback to product-level cost
        if(vpCNY){
          anyVarHasCost = true;
          const mult    = p.categoryMultiplier || CAT_MULTIPLIERS[p.category||'general'] || 1.78;
          const srcMeth = p.sourceMethod || 'agent';
          const oldPrice= vp.price||0;
          const newPrice= calcListingPrice(vpCNY, newRate, srcMeth, mult);
          const diff    = newPrice - oldPrice;
          const pct     = oldPrice ? ((diff/oldPrice)*100).toFixed(1) : '‚Äî';
          hasCostProducts.push({
            productId: p.id,
            name:      p.name||'',
            category:  p.category||'',
            variantIdx: idx,
            variantLabel: vp.label||`Tier ${idx+1}`,
            oldPrice, newPrice, diff, pct,
            isVariant: true,
            hasCost: true
          });
        }
      });
      if(!anyVarHasCost && !p.costCNY){
        missingCostProducts.push(p);
      }
    } else {
      if(p.costCNY){
        const mult    = p.categoryMultiplier || CAT_MULTIPLIERS[p.category||'general'] || 1.78;
        const srcMeth = p.sourceMethod || 'agent';
        const oldPrice= p.price||0;
        const newPrice= calcListingPrice(p.costCNY, newRate, srcMeth, mult);
        const diff    = newPrice - oldPrice;
        const pct     = oldPrice ? ((diff/oldPrice)*100).toFixed(1) : '‚Äî';
        hasCostProducts.push({
          productId: p.id,
          name:      p.name||'',
          category:  p.category||'',
          variantIdx: null,
          variantLabel: null,
          oldPrice, newPrice, diff, pct,
          isVariant: false,
          hasCost: true
        });
      } else {
        missingCostProducts.push(p);
      }
    }
  });

  _repriceRows = hasCostProducts;

  // Render preview table
  const tbody = document.getElementById('reprice-preview-tbody');
  if(!_repriceRows.length){
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:30px">No products with Factory Cost (CNY) data found. Add costCNY to products to use this feature.</td></tr>`;
  } else {
    tbody.innerHTML = _repriceRows.map((r,i)=>{
      const upDown = r.diff > 0 ? 'price-up' : r.diff < 0 ? 'price-down' : '';
      const diffStr = r.diff > 0 ? '+'+fmt(r.diff) : fmt(r.diff);
      return `
      <tr class="${upDown}" data-row-idx="${i}">
        <td><input type="checkbox" class="reprice-row-check" data-idx="${i}" checked style="cursor:pointer;accent-color:var(--teal-bright);width:16px;height:16px;" onchange="updateRepriceSummary()"></td>
        <td><strong>${escHtml(r.name)}</strong></td>
        <td><span class="badge badge-muted" style="font-size:10px;">${escHtml(r.category)}</span></td>
        <td style="color:var(--muted2);font-size:12px;">${escHtml(r.variantLabel||'‚Äî')}</td>
        <td style="color:var(--muted2);">${fmt(r.oldPrice)}</td>
        <td><strong style="color:var(--gold-bright);">${fmt(r.newPrice)}</strong></td>
        <td class="change-col" style="font-weight:700;">${diffStr}</td>
        <td style="font-size:12px;${r.diff>=0?'color:#4ade80':'color:#f87171'}">${r.pct !== '‚Äî' ? r.pct+'%' : '‚Äî'}</td>
      </tr>`;
    }).join('');
  }

  // Missing section
  const missSection = document.getElementById('reprice-missing-section');
  const missList    = document.getElementById('reprice-missing-list');
  if(missingCostProducts.length){
    missSection.style.display='block';
    missList.innerHTML = missingCostProducts.map(p=>`
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--card);border-radius:8px;padding:10px 14px;">
        <div>
          <strong style="font-size:13px;">${escHtml(p.name||'')}</strong>
          <span class="badge badge-muted" style="font-size:10px;margin-left:8px;">${escHtml(p.category||'')}</span>
        </div>
        <button class="btn btn-outline btn-sm" onclick="editProduct('${escHtml(p.id)}');document.getElementById('product-modal').scrollTop=300">‚úèÔ∏è Add Cost</button>
      </div>`).join('');
  } else {
    missSection.style.display='none';
  }

  // Summary
  document.getElementById('reprice-preview-summary-top').textContent =
    `Previewing rate change to ‚Ç¶${Number(newRate).toLocaleString('en-NG')}/¬•1. ${_repriceRows.length} rows found with cost data.`;

  // Show the will-skip in summary
  document.getElementById('reprice-will-skip').textContent = missingCostProducts.length;
  document.getElementById('reprice-will-update').textContent = _repriceRows.length;

  document.getElementById('reprice-preview-wrap').style.display='block';
  document.getElementById('reprice-progress').style.display='none';

  // Sync check-all state
  const allCheck = document.getElementById('reprice-check-all');
  if(allCheck) allCheck.checked = true;
};

window.toggleAllRepriceChecks = function(checked){
  document.querySelectorAll('.reprice-row-check').forEach(c=>{ c.checked = checked; });
  updateRepriceSummary();
};

window.updateRepriceSummary = function(){
  const checkedCount = document.querySelectorAll('.reprice-row-check:checked').length;
  document.getElementById('reprice-will-update').textContent = checkedCount;
};

window.applyReprice = async function(){
  const newRate = Number(document.getElementById('reprice-new-rate').value||0);
  if(!newRate){ toast('No rate entered', true); return; }

  const checkedBoxes = Array.from(document.querySelectorAll('.reprice-row-check:checked'));
  if(!checkedBoxes.length){ toast('No products selected to update', true); return; }

  const progressWrap  = document.getElementById('reprice-progress');
  const progressBar   = document.getElementById('reprice-progress-bar');
  const progressLabel = document.getElementById('reprice-progress-label');
  const progressDetail= document.getElementById('reprice-progress-detail');

  progressWrap.style.display='block';
  progressBar.style.width='0%';
  progressLabel.textContent = 'Preparing batch update‚Ä¶';
  progressDetail.textContent = `0 / ${checkedBoxes.length} products`;

  try {
    // 1. Save new exchange rate to settings
    progressLabel.textContent = 'Saving new exchange rate‚Ä¶';
    await setDoc(doc(db,'settings','site-config'), {
      exchangeRate: newRate,
      exchangeRateUpdatedAt: serverTimestamp()
    }, {merge:true});

    progressBar.style.width='10%';

    // 2. Group checked rows by productId to build update payloads
    const productUpdates = {}; // productId => {price?, variantPrices?[]}

    checkedBoxes.forEach(cb=>{
      const idx = Number(cb.dataset.idx);
      const row = _repriceRows[idx];
      if(!row) return;

      if(!productUpdates[row.productId]){
        const p = _allProducts.find(x=>x.id===row.productId);
        productUpdates[row.productId] = {
          product: p,
          newBasePrice: null,
          variantUpdates: {} // idx -> newPrice
        };
      }

      if(row.isVariant){
        productUpdates[row.productId].variantUpdates[row.variantIdx] = row.newPrice;
      } else {
        productUpdates[row.productId].newBasePrice = row.newPrice;
      }
    });

    const productIds = Object.keys(productUpdates);
    const total = productIds.length;

    // 3. Batch write ‚Äî Firebase max 500 ops per batch
    const BATCH_LIMIT = 490;
    let batchCount = 0;
    let currentBatch = writeBatch(db);
    let processed = 0;

    for(const productId of productIds){
      const upd  = productUpdates[productId];
      const p    = upd.product;
      if(!p) continue;

      const payload = { updatedAt: serverTimestamp() };

      // Update base price if applicable
      if(upd.newBasePrice !== null){
        payload.price = upd.newBasePrice;
      }

      // Update variantPrices if applicable
      if(Object.keys(upd.variantUpdates).length > 0 && Array.isArray(p.variantPrices)){
        const updatedVPs = p.variantPrices.map((vp, idx)=>{
          if(upd.variantUpdates[idx] !== undefined){
            return {...vp, price: upd.variantUpdates[idx]};
          }
          return vp;
        });
        payload.variantPrices = updatedVPs;
        // Also update base price to first variant price for consistency
        if(updatedVPs.length > 0 && upd.newBasePrice === null){
          payload.price = updatedVPs[0].price;
        }
      }

      currentBatch.update(doc(db,'products',productId), payload);
      batchCount++;
      processed++;

      if(batchCount >= BATCH_LIMIT){
        progressLabel.textContent = 'Writing to Firestore‚Ä¶';
        await currentBatch.commit();
        currentBatch = writeBatch(db);
        batchCount = 0;
      }

      const pct = Math.round(10 + (processed/total)*85);
      progressBar.style.width = pct + '%';
      progressDetail.textContent = `${processed} / ${total} products‚Ä¶`;
    }

    // Commit remaining
    if(batchCount > 0){
      await currentBatch.commit();
    }

    progressBar.style.width = '100%';
    progressLabel.textContent = '‚úÖ All prices updated successfully!';
    progressDetail.textContent = `${processed} products updated. Storefront prices are now live.`;

    toast(`‚úÖ ${processed} products updated at ‚Ç¶${Number(newRate).toLocaleString('en-NG')}/¬•1`);

    // Clear preview after success
    setTimeout(()=>{
      document.getElementById('reprice-preview-wrap').style.display='none';
      document.getElementById('reprice-new-rate').value='';
      _repriceRows = [];
    }, 4000);

  } catch(e){
    progressLabel.textContent = '‚ùå Error during update';
    progressDetail.textContent = e.message;
    toast('Batch update error: '+e.message, true);
  }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REFERRALS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReferrals(){
  // Tier summary
  const tierCounts = {};
  const TIER_THRESHOLDS = {bronze:1,silver:3,gold:5,platinum:10};
  const referrerMap = {};
  _allOrders.filter(o=>o.referralCode).forEach(o=>{
    const code = o.referralCode.toLowerCase().trim();
    if(!referrerMap[code]) referrerMap[code]=[];
    referrerMap[code].push(o);
  });
  const statEl = document.getElementById('ref-tier-stats');
  if(statEl){
    const tierColors = {bronze:'#D4894A',silver:'#C8C8C8',gold:'var(--gold-bright)',platinum:'#A78BFA'};
    statEl.innerHTML = Object.entries(TIER_THRESHOLDS).map(([tier,req])=>{
      const qualifiers = Object.values(referrerMap).filter(orders=>orders.length>=req).length;
      return `<div style="background:var(--card);border:1px solid #ffffff0a;border-radius:var(--radius);padding:16px;text-align:center">
        <div style="font-size:24px;margin-bottom:6px">${tier==='bronze'?'ü•â':tier==='silver'?'ü•à':tier==='gold'?'ü•á':'üíé'}</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:30px;color:${tierColors[tier]}">${qualifiers}</div>
        <div style="font-size:11px;color:var(--muted2);text-transform:uppercase;letter-spacing:.6px">${tier} (${req}+ referrals)</div>
      </div>`;
    }).join('');
  }
  // Table
  const tbody = document.getElementById('ref-tbody');
  if(!tbody) return;
  const refOrders = _allOrders.filter(o=>o.referralCode);
  if(!refOrders.length){ tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">No referral orders yet.</td></tr>`; return; }
  tbody.innerHTML = refOrders.map(o=>{
    const code = o.referralCode||'';
    const refCount = (referrerMap[code.toLowerCase().trim()]||[]).length;
    const tier = refCount>=10?'üíé Platinum':refCount>=5?'ü•á Gold':refCount>=3?'ü•à Silver':'ü•â Bronze';
    return `<tr>
      <td><strong style="color:var(--gold-bright)">${escHtml(code)}</strong></td>
      <td><code style="font-size:11px;color:var(--muted2)">${escHtml(o.txRef||o.id)}</code></td>
      <td>${escHtml((o.customer?.firstName||'')+' '+(o.customer?.lastName||''))}</td>
      <td><strong>${fmt(o.totalPaid)}</strong></td>
      <td>${tier}</td>
      <td>${statusBadge(o.orderStatus)}</td>
      <td style="color:var(--muted2);font-size:11px">${formatDate(o.createdAt)}</td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SETTINGS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applySettings(s){
  if(document.getElementById('s-ann'))         document.getElementById('s-ann').value         = s.announcementText||'';
  if(document.getElementById('s-slots-total')) document.getElementById('s-slots-total').value = s.urgencySlots?.total||15;
  if(document.getElementById('s-slots-rem'))  document.getElementById('s-slots-rem').value  = s.urgencySlots?.remaining||7;
  if(document.getElementById('s-fee-ph'))     document.getElementById('s-fee-ph').value     = s.deliveryFeePH??0;
  if(document.getElementById('s-fee-other'))  document.getElementById('s-fee-other').value  = s.deliveryFeeOther??5000;
  if(document.getElementById('s-fee-lagos'))  document.getElementById('s-fee-lagos').value  = s.deliveryFeeLagos??7500;
  if(document.getElementById('s-fee-north'))  document.getElementById('s-fee-north').value  = s.deliveryFeeNorth??9000;
  if(document.getElementById('s-wa'))         document.getElementById('s-wa').value         = s.whatsappNumber||'';
  if(document.getElementById('s-round'))      document.getElementById('s-round').value      = s.currentRound||'';
  if(document.getElementById('s-accepting'))  document.getElementById('s-accepting').checked= s.acceptingOrders!==false;
  if(document.getElementById('s-maintenance'))document.getElementById('s-maintenance').checked= !!s.maintenanceMode;
  if(document.getElementById('s-exchange-rate') && s.exchangeRate){
    document.getElementById('s-exchange-rate').value = s.exchangeRate;
  }
  if(document.getElementById('s-rate-last-updated')){
    if(s.exchangeRateUpdatedAt?.toDate){
      document.getElementById('s-rate-last-updated').textContent =
        s.exchangeRateUpdatedAt.toDate().toLocaleDateString('en-NG',{weekday:'short',day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
    } else {
      document.getElementById('s-rate-last-updated').textContent = 'Never';
    }
  }
  if(s.countdownDeadline?.toDate && document.getElementById('s-deadline')){
    const d = s.countdownDeadline.toDate();
    document.getElementById('s-deadline').value = d.toISOString().slice(0,16);
  }
}

window.saveExchangeRate = async function(){
  const rate = Number(document.getElementById('s-exchange-rate').value||0);
  if(!rate || rate < 1){ toast('Please enter a valid exchange rate', true); return; }
  try {
    await setDoc(doc(db,'settings','site-config'), {
      exchangeRate: rate,
      exchangeRateUpdatedAt: serverTimestamp()
    }, {merge:true});
    toast(`‚úÖ Exchange rate saved: ‚Ç¶${rate.toLocaleString('en-NG')}/¬•1`);
  } catch(e){ toast('Error: '+e.message, true); }
};

window.saveSetting = async function(key, value){
  try {
    await setDoc(doc(db,'settings','site-config'),{[key]:value},{merge:true});
    toast(`‚úÖ ${key} updated`);
  } catch(e){ toast('Error: '+e.message, true); }
};

window.saveUrgency = async function(){
  const total   = Number(document.getElementById('s-slots-total').value||15);
  const rem     = Number(document.getElementById('s-slots-rem').value||7);
  const dlStr   = document.getElementById('s-deadline').value;
  const payload = { urgencySlots:{total,remaining:rem} };
  if(dlStr){
    const { Timestamp } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
    payload.countdownDeadline = Timestamp.fromDate(new Date(dlStr));
  }
  try {
    await setDoc(doc(db,'settings','site-config'), payload, {merge:true});
    toast('‚úÖ Urgency settings saved');
  } catch(e){ toast('Error: '+e.message, true); }
};

window.saveDeliveryFees = async function(){
  const payload = {
    deliveryFeePH:    Number(document.getElementById('s-fee-ph').value||0),
    deliveryFeeOther: Number(document.getElementById('s-fee-other').value||5000),
    deliveryFeeLagos: Number(document.getElementById('s-fee-lagos').value||7500),
    deliveryFeeNorth: Number(document.getElementById('s-fee-north').value||9000),
  };
  try {
    await setDoc(doc(db,'settings','site-config'), payload, {merge:true});
    toast('‚úÖ Delivery fees saved');
  } catch(e){ toast('Error: '+e.message, true); }
};

window.saveSiteControls = async function(){
  const payload = {
    whatsappNumber:  document.getElementById('s-wa').value.trim(),
    currentRound:    document.getElementById('s-round').value.trim(),
  };
  try {
    await setDoc(doc(db,'settings','site-config'), payload, {merge:true});
    toast('‚úÖ Site settings saved');
  } catch(e){ toast('Error: '+e.message, true); }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UTIL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function statusBadge(s){
  const m = {processing:'badge-gold',shipped:'badge-purple',delivered:'badge-teal'};
  const l = {processing:'üîÑ Processing',shipped:'‚úàÔ∏è Shipped',delivered:'‚úÖ Delivered'};
  return `<span class="badge ${m[s]||'badge-muted'}">${l[s]||s||'‚Äî'}</span>`;
}
function formatDate(ts){
  if(!ts?.toDate) return '‚Äî';
  const d = ts.toDate();
  return d.toLocaleDateString('en-NG',{day:'2-digit',month:'short',year:'numeric'});
}

</script>
</body>
</html>
